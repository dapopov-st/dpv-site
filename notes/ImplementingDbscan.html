<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-01-01">
<meta name="description" content="Implementing DBSCAN for CPU and GPU">

<title>Implementing DBSCAN – Dmitriy Popov-Velasco</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-8d71775160d4fd80c1615d480316b826.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Dmitriy Popov-Velasco</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts.html"> 
<span class="menu-text">Blogs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../notes.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/dapvelasco"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:dpopovvelasco@gmail.com"> <i class="bi bi-envelope" role="img" aria-label="email">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dapopov-st"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Implementing DBSCAN</h1>
                  <div>
        <div class="description">
          Implementing DBSCAN for CPU and GPU
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">PyTorch</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 1, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div id="cell-1" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-2" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.datasets <span class="im">import</span> make_moons</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.cluster <span class="im">import</span> DBSCAN</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This was inspired by a fastai Part 2 assignment by Jeremy Howard. The main idea is to practice implementing algorithms on a GPU for practice with broadcasting and other key techniques relevant to working on GPUs.</p>
<p>There are 4 Steps - CPU implementation - Slower simple GPU implementation - Somewhat faster simple GPU implementation - Much faster cuml GPU implementation with brief explanation of what makes it work - See what replacing only the distance calculation does in my slower GPU implementation</p>
<section id="dbscan" class="level2">
<h2 class="anchored" data-anchor-id="dbscan">DBSCAN</h2>
<section id="first-check-look-at-the-desired-behavior-using-the-default-implementation" class="level3">
<h3 class="anchored" data-anchor-id="first-check-look-at-the-desired-behavior-using-the-default-implementation">First, check look at the desired behavior using the default implementation</h3>
<div id="cell-7" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">=</span> DBSCAN(eps<span class="op">=</span><span class="fl">0.2</span>, min_samples<span class="op">=</span><span class="dv">5</span>, metric<span class="op">=</span><span class="st">'euclidean'</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> make_moons(n_samples<span class="op">=</span><span class="dv">200</span>, noise<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-8" class="cell" data-executioninfo="{&quot;elapsed&quot;:1671,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705855966035,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="6d8bf8e0-391b-42ba-f646-07c364bd03f1">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>y_db <span class="op">=</span> db.fit_predict(X)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(y_db,<span class="bu">len</span>(y_db))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">len</span>(X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">0</span>]), <span class="bu">len</span>(X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>]))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature 1'</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Feature 2'</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0 1 1 0 1 1 0 1 0 1 0 1 1 1 0 0 0 1 0 0 1 1 0 1 0 1 1 1 1 0 0 0 1 1 0 1 1
 0 0 1 1 0 0 1 1 0 0 0 1 1 0 1 1 0 1 0 0 1 0 0 1 0 1 0 1 0 0 1 0 0 1 0 1 1
 1 0 1 0 0 1 1 0 1 1 1 0 0 0 1 1 0 0 1 0 1 1 1 1 0 1 1 1 0 0 0 1 0 0 1 0 0
 0 0 0 0 1 0 1 1 0 0 0 1 0 1 0 0 1 1 1 0 0 0 1 1 1 1 0 1 0 1 1 0 0 0 0 1 1
 0 1 1 1 0 0 1 0 1 1 0 0 1 1 0 1 1 1 0 1 1 1 0 0 0 0 1 1 1 0 0 0 1 0 1 1 1
 0 0 1 0 0 0 0 0 0 1 0 1 1 0 1] 200
100 100</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ImplementingDbscan_files/figure-html/cell-5-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="dbscan-custom-implementation" class="level3">
<h3 class="anchored" data-anchor-id="dbscan-custom-implementation">DBSCAN custom implementation</h3>
<ul>
<li>A point is a core point if at least a specified number min_samples of neighboring points fall within eps radius</li>
<li>A <em>border point</em> is a point that has fewer than min_samples within eps, but lies within the radius eps of a core point</li>
<li>All other points that are neither core nor border points are <em>noise points</em></li>
</ul>
<p>Algorithm - Label the points as core, border, or noise. - Form a separate cluster for each core point or connected group of core points. (Core points are connected if they are no farther away than eps). - Assign each border point to the cluster of its corresponding core points.</p>
<ul>
<li>Want border point to have a reference to its core point for easy merging</li>
<li>Once merge cluster points, want to go find and update corresponding border points’ reference</li>
</ul>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DbscanCustom: <span class="co">#(torch.nn.Module):</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps, min_samples):</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_samples <span class="op">=</span> min_samples</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Label points as core or assign border to core, skip if noise</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_points(X)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Form clusters of connected groups of core points</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Avoid RuntimeError: dictionary changed size during iteration,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make a copy of the keys!!!</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        keys <span class="op">=</span> <span class="bu">list</span>(<span class="va">self</span>.mapping.keys())</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(len(keys)+sum([len(v) for _,v in self.mapping.items()]))</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx,i <span class="kw">in</span> <span class="bu">enumerate</span>(keys[:<span class="op">-</span><span class="dv">1</span>]): <span class="co"># iterating through a list now!</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> j <span class="kw">in</span> keys[idx<span class="op">+</span><span class="dv">1</span>:]:</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            <span class="co">#if i == j: continue</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>              <span class="co">#print(self.mapping[i],self.mapping[j])</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.mapping[j].add(i) <span class="co">#IN-PLACE</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.mapping[j]<span class="op">=</span><span class="va">self</span>.mapping[j].union(<span class="va">self</span>.mapping[i]) <span class="co">#NOT IN-PLACE!!!!!!!!!!</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>              <span class="bu">print</span>(<span class="ss">f"Deleting </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>mapping[i]<span class="sc">}</span><span class="ss"> and i is </span><span class="sc">{</span>i<span class="sc">}</span><span class="ss"> and self.mapping[j] is </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>mapping[j]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>              <span class="kw">del</span> <span class="va">self</span>.mapping[i]</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>              merged.add(i)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>              <span class="cf">break</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>          <span class="co">#if i in merged: continue</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Relabel clusters</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.mapping)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        final_map <span class="op">=</span> {i:v <span class="cf">for</span> i, (k,v) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.mapping.items())}</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        len_pts <span class="op">=</span> <span class="bu">len</span>(final_map)<span class="op">+</span><span class="bu">sum</span>([<span class="bu">len</span>(v) <span class="cf">for</span> _,v <span class="kw">in</span> final_map.items()])</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(final_map, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, len_pts)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> final_map</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> label_points(<span class="va">self</span>, X):</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""1. Label the points as core, border, or noise."""</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mapping <span class="op">=</span> {}</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X  <span class="op">=</span> X</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_core_points()</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_border_points()</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ignore the noise points, don't need them later</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_core_points(<span class="va">self</span>):</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X):</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.is_core_point(i):</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.mapping[i] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_border_points(<span class="va">self</span>):</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(X):</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.mapping:</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.map_border(i)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_core_point(<span class="va">self</span>, i):</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">TODO</span><span class="co">: update to point to itself?</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A point is a core point if at least a specified number min_samples of neighboring points fall within eps radius"""</span></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        num_within <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X): <span class="co"># </span><span class="al">TODO</span><span class="co">: Keys vs indices; straighten up!</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>              num_within <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> num_within <span class="op">&gt;=</span> <span class="va">self</span>.min_samples:</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print(X[i],X[j],self.distance(i,j),num_within,self.min_samples)</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_border(<span class="va">self</span>, i):</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">TODO</span><span class="co">: update to point to point to its core idx</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A *border point* is a point that has fewer than min_samples within eps, but lies within the radius eps of a core point"""</span></span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="va">self</span>.mapping:</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.mapping[j].add(i)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> distance(<span class="va">self</span>,i,j):</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>      <span class="co">"""Distance between points of self.X with indices i and j"""</span></span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(np.sqrt(np.sum((self.X[i]-self.X[j])**2)))</span></span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> np.sqrt(np.<span class="bu">sum</span>((<span class="va">self</span>.X[i]<span class="op">-</span><span class="va">self</span>.X[j])<span class="op">**</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-13" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DbscanCustom: <span class="co">#(torch.nn.Module):</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps, min_samples):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_samples <span class="op">=</span> min_samples</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Label points as core or assign border to core, skip if noise</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_points(X)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Form clusters of connected groups of core points</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Avoid RuntimeError: dictionary changed size during iteration,</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># make a copy of the keys!!!</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        keys <span class="op">=</span> <span class="bu">list</span>(<span class="va">self</span>.mapping.keys())</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(keys)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print(len(keys)+sum([len(v) for _,v in self.mapping.items()]))</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>        merged <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx,i <span class="kw">in</span> <span class="bu">enumerate</span>(keys[:<span class="op">-</span><span class="dv">1</span>]): <span class="co"># iterating through a list now!</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> j <span class="kw">in</span> keys[idx<span class="op">+</span><span class="dv">1</span>:]:</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">#if i == j: continue</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>              <span class="co">#print(self.mapping[i],self.mapping[j])</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.mapping[j].add(i) <span class="co">#IN-PLACE</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.mapping[j]<span class="op">=</span><span class="va">self</span>.mapping[j].union(<span class="va">self</span>.mapping[i]) <span class="co">#NOT IN-PLACE!!!!!!!!!!</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>              merged.add(i)</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="kw">in</span> merged:</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print(f"Deleting {self.mapping[i]} and i is {i} and self.mapping[j] is {self.mapping[j]}")</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">del</span> <span class="va">self</span>.mapping[i]</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            <span class="co">#break</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>          <span class="co">#if i in merged: continue</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Relabel clusters</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.mapping)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        final_map <span class="op">=</span> {i:v <span class="cf">for</span> i, (k,v) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.mapping.items())}</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        len_pts <span class="op">=</span> <span class="bu">len</span>(final_map)<span class="op">+</span><span class="bu">sum</span>([<span class="bu">len</span>(v) <span class="cf">for</span> _,v <span class="kw">in</span> final_map.items()])</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(final_map, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, len_pts)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> final_map</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> label_points(<span class="va">self</span>, X):</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""1. Label the points as core, border, or noise."""</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mapping <span class="op">=</span> {}</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X  <span class="op">=</span> X</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_core_points()</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_border_points()</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ignore the noise points, don't need them later</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_core_points(<span class="va">self</span>):</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X):</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.is_core_point(i):</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.mapping[i] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_border_points(<span class="va">self</span>):</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(X):</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.mapping:</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.map_border(i)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> is_core_point(<span class="va">self</span>, i):</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">TODO</span><span class="co">: update to point to itself?</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A point is a core point if at least a specified number min_samples of neighboring points fall within eps radius"""</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        num_within <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X): <span class="co"># </span><span class="al">TODO</span><span class="co">: Keys vs indices; straighten up!</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>              num_within <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> num_within <span class="op">&gt;=</span> <span class="va">self</span>.min_samples:</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print(X[i],X[j],self.distance(i,j),num_within,self.min_samples)</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_border(<span class="va">self</span>, i):</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">TODO</span><span class="co">: update to point to point to its core idx</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A *border point* is a point that has fewer than min_samples within eps, but lies within the radius eps of a core point"""</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="va">self</span>.mapping:</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.mapping[j].add(i)</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> distance(<span class="va">self</span>,i,j):</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>      <span class="co">"""Distance between points of self.X with indices i and j"""</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(np.sqrt(np.sum((self.X[i]-self.X[j])**2)))</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(np.sqrt(np.sum((self.X[20]-self.X[199])**2)))</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> np.sqrt(np.<span class="bu">sum</span>((<span class="va">self</span>.X[i]<span class="op">-</span><span class="va">self</span>.X[j])<span class="op">**</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Next, handle border points</li>
<li>I think the three remaining points are probably border points and need to be mapped to their respective cluster!!!!</li>
</ul>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DbscanCustom: <span class="co">#(torch.nn.Module):</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps, min_samples):</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_samples <span class="op">=</span> min_samples</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.edges <span class="op">=</span> [] <span class="co"># for union find</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find(<span class="va">self</span>,i):</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>      res <span class="op">=</span> i</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="va">self</span>.parents[res]<span class="op">!=</span>res:</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[res] <span class="op">=</span> <span class="va">self</span>.parents[<span class="va">self</span>.parents[res]]</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> <span class="va">self</span>.parents[res]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> union(<span class="va">self</span>, i,j):</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>      pi, pj <span class="op">=</span> <span class="va">self</span>.find(i), <span class="va">self</span>.find(j)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> pi <span class="op">==</span> pj: <span class="cf">return</span> <span class="dv">0</span>, <span class="va">None</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="va">self</span>.rank[pi] <span class="op">&gt;=</span> <span class="va">self</span>.rank[pj]:</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[pj] <span class="op">=</span> pi</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank[pi] <span class="op">+=</span> <span class="va">self</span>.rank[pj]</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span>, i</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[pi] <span class="op">=</span> pj</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank[pj] <span class="op">+=</span> <span class="va">self</span>.rank[pi]</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">1</span>, j</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(X)))</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank <span class="op">=</span> [<span class="dv">1</span>]<span class="op">*</span><span class="bu">len</span>(X)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mapping <span class="op">=</span> {}</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X <span class="op">=</span> X</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Label points as core or assign border to core, skip if noise</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_points(X)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        keys <span class="op">=</span> <span class="bu">list</span>(<span class="va">self</span>.mapping.keys())</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(keys)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, j <span class="kw">in</span> <span class="va">self</span>.edges:</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="kw">in</span> <span class="va">self</span>.mapping <span class="kw">and</span> j <span class="kw">in</span> <span class="va">self</span>.mapping:</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            res,p <span class="op">=</span> <span class="va">self</span>.union(i,j) <span class="co">#0 or 1, idx</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            <span class="co">#if res: n -= 1</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> res <span class="kw">and</span> p <span class="op">==</span> i:</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.mapping[i].update(<span class="va">self</span>.mapping[j])</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>              <span class="co">#del self.mapping[j]</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> res <span class="kw">and</span> p <span class="op">==</span> j:</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.mapping[j].update(<span class="va">self</span>.mapping[i])</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>              <span class="co">#del self.mapping[i]</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"SELF.MAPPING"</span>)</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.mapping)</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"PARENTS"</span>)</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.parents)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Parents len"</span>)</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="bu">len</span>(<span class="va">self</span>.parents))</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"CLUSTERS"</span>)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="bu">set</span>(<span class="va">self</span>.parents))</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"RANKS"</span>)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.rank)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.parents[<span class="dv">3</span>], <span class="va">self</span>.parents[<span class="dv">73</span>], <span class="va">self</span>.parents[<span class="dv">103</span>])</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        final_map <span class="op">=</span> {}</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        counts <span class="op">=</span> Counter(<span class="va">self</span>.parents)</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">#cluster_rename = {i:v for i,(k,v) in enumerate(counts.items()) if counts[k]&gt;1}</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print("CLUSTER RENAME")</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(cluster_rename)</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> [np.nan]<span class="op">*</span><span class="bu">len</span>(X)</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        all_vals <span class="op">=</span> <span class="va">self</span>.mapping.values()</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx,elt <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.parents):</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> elt <span class="kw">not</span> <span class="kw">in</span> final_map:</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>              final_map[elt] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> counts[elt]<span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>            final_map[elt].add(idx)</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>        v_to_k <span class="op">=</span> {v1:k <span class="cf">for</span> k,v <span class="kw">in</span> <span class="va">self</span>.mapping.items() <span class="cf">for</span> v1 <span class="kw">in</span> v <span class="cf">if</span> v}</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"v_to_k"</span>)</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(v_to_k)</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(final_map)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="bu">len</span>(final_map))</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>        final_map <span class="op">=</span> {i:v <span class="cf">for</span> i, (k,v) <span class="kw">in</span> <span class="bu">enumerate</span>(final_map.items())}</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(final_map)</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i,v <span class="kw">in</span> final_map.items():</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> j <span class="kw">in</span> v:</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>            result[j] <span class="op">=</span> i</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v,k <span class="kw">in</span> v_to_k.items():</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>          result[v]  <span class="op">=</span> result[k]</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(result)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.array(result)</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># final_map = {i:v for i, (k,v) in enumerate(self.mapping.items())}</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># len_pts = len(final_map)+sum([len(v) for _,v in final_map.items()])</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(final_map, "\n", len_pts)</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">#return final_map</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> label_points(<span class="va">self</span>, X):</span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""1. Label the points as core, border, or noise."""</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.mapping <span class="op">=</span> {}</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X  <span class="op">=</span> X</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_core_points()</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_border_points()</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"EDGES:"</span>)</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="va">self</span>.edges)</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ignore the noise points, don't need them later</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_core_points(<span class="va">self</span>):</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X):</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.map_core(i):</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.mapping[i] <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_border_points(<span class="va">self</span>):</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(X):</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.mapping:</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.map_border(i)</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_core(<span class="va">self</span>, i):</span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">TODO</span><span class="co">: update to point to itself?</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A point is a core point if at least a specified number min_samples of neighboring points fall within eps radius"""</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>        num_within <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X): <span class="co"># </span><span class="al">TODO</span><span class="co">: Keys vs indices; straighten up!</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.edges.append([i,j])</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>              num_within <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_within <span class="op">&gt;=</span> <span class="va">self</span>.min_samples:</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_border(<span class="va">self</span>, i):</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>      <span class="co"># </span><span class="al">TODO</span><span class="co">: update to point to point to its core idx</span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A *border point* is a point that has fewer than min_samples within eps, but lies within the radius eps of a core point"""</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>        min_dist <span class="op">=</span> <span class="va">self</span>.eps</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>        min_idx <span class="op">=</span> <span class="va">None</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="va">self</span>.mapping:</span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> min_dist:</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>              min_dist <span class="op">=</span> <span class="va">self</span>.distance(i,j)</span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>              min_idx <span class="op">=</span> j</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> min_idx: <span class="va">self</span>.mapping[min_idx].add(i)</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> distance(<span class="va">self</span>,i,j):</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>      <span class="co">"""Distance between points of self.X with indices i and j"""</span></span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>      <span class="co">#print(np.sqrt(np.sum((self.X[i]-self.X[j])**2)))</span></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> np.sqrt(np.<span class="bu">sum</span>((<span class="va">self</span>.X[i]<span class="op">-</span><span class="va">self</span>.X[j])<span class="op">**</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-16" class="cell" data-executioninfo="{&quot;elapsed&quot;:2218,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705855970582,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="7a244f93-08c4-4bf4-98aa-1fd638c94a75">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> make_moons(n_samples<span class="op">=</span><span class="dv">200</span>, noise<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>db_custom <span class="op">=</span> DbscanCustom(eps<span class="op">=</span><span class="fl">0.2</span>, min_samples<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>y_db <span class="op">=</span> db_custom.fit_predict(X)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature 1'</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Feature 2'</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>EDGES:
[[0, 8], [0, 30], [0, 34], [0, 55], [0, 63], [0, 77], [0, 114], [0, 119], [0, 120], [0, 139], [0, 152], [0, 192], [1, 44], [1, 67], [1, 96], [1, 108], [1, 151], [1, 163], [1, 168], [1, 180], [1, 183], [1, 199], [2, 33], [2, 39], [2, 76], [2, 84], [2, 105], [2, 122], [2, 124], [2, 141], [2, 149], [2, 194], [3, 53], [3, 106], [3, 171], [4, 5], [4, 12], [4, 26], [4, 62], [4, 95], [4, 96], [4, 135], [4, 151], [4, 165], [4, 183], [4, 199], [5, 4], [5, 12], [5, 20], [5, 26], [5, 27], [5, 52], [5, 62], [5, 80], [5, 95], [5, 117], [6, 8], [6, 15], [6, 37], [6, 46], [6, 86], [6, 91], [6, 114], [6, 126], [6, 130], [6, 139], [6, 145], [6, 193], [7, 21], [7, 32], [7, 49], [7, 54], [7, 74], [7, 79], [7, 167], [7, 169], [7, 175], [7, 187], [8, 0], [8, 6], [8, 15], [8, 30], [8, 63], [8, 77], [8, 91], [8, 114], [8, 120], [8, 130], [8, 139], [8, 152], [8, 192], [8, 193], [9, 13], [9, 32], [9, 54], [9, 57], [9, 64], [9, 100], [9, 134], [9, 136], [9, 156], [9, 161], [9, 169], [9, 175], [10, 31], [10, 41], [10, 45], [10, 85], [10, 87], [10, 107], [10, 131], [10, 143], [10, 144], [10, 195], [11, 17], [11, 25], [11, 28], [11, 36], [11, 48], [11, 51], [11, 60], [11, 97], [11, 133], [11, 157], [11, 164], [12, 4], [12, 5], [12, 20], [12, 26], [12, 27], [12, 62], [12, 95], [12, 96], [12, 165], [12, 183], [13, 9], [13, 23], [13, 54], [13, 57], [13, 64], [13, 100], [13, 128], [13, 134], [13, 136], [13, 147], [13, 156], [13, 161], [14, 19], [14, 38], [14, 47], [14, 93], [14, 121], [14, 125], [14, 172], [14, 173], [14, 177], [14, 178], [14, 181], [15, 6], [15, 8], [15, 37], [15, 46], [15, 86], [15, 91], [15, 114], [15, 126], [15, 130], [15, 145], [15, 193], [16, 18], [16, 56], [16, 78], [16, 142], [16, 153], [16, 158], [16, 159], [16, 162], [16, 166], [16, 170], [16, 179], [16, 191], [17, 11], [17, 36], [17, 51], [17, 60], [17, 97], [17, 133], [17, 150], [17, 157], [17, 164], [18, 16], [18, 22], [18, 58], [18, 90], [18, 109], [18, 142], [18, 148], [18, 153], [18, 158], [18, 166], [18, 185], [18, 191], [19, 14], [19, 47], [19, 50], [19, 93], [19, 110], [19, 125], [19, 177], [19, 189], [20, 5], [20, 12], [20, 26], [20, 27], [20, 52], [20, 62], [20, 80], [20, 95], [20, 117], [20, 182], [21, 7], [21, 32], [21, 49], [21, 54], [21, 74], [21, 79], [21, 167], [21, 169], [21, 175], [21, 187], [22, 18], [22, 29], [22, 58], [22, 68], [22, 90], [22, 102], [22, 109], [22, 111], [22, 148], [22, 153], [22, 185], [22, 198], [23, 13], [23, 57], [23, 67], [23, 115], [23, 128], [23, 134], [23, 136], [23, 147], [23, 156], [23, 163], [23, 180], [24, 31], [24, 45], [24, 59], [24, 66], [24, 85], [24, 87], [24, 143], [24, 155], [24, 186], [25, 11], [25, 28], [25, 43], [25, 48], [25, 51], [25, 127], [25, 133], [25, 140], [25, 146], [25, 157], [25, 160], [25, 174], [25, 197], [26, 4], [26, 5], [26, 12], [26, 20], [26, 27], [26, 52], [26, 62], [26, 95], [26, 96], [26, 165], [26, 183], [27, 5], [27, 12], [27, 20], [27, 26], [27, 35], [27, 52], [27, 62], [27, 80], [27, 95], [27, 117], [27, 182], [27, 196], [28, 11], [28, 25], [28, 43], [28, 48], [28, 51], [28, 99], [28, 127], [28, 133], [28, 140], [28, 146], [28, 157], [28, 160], [28, 174], [28, 197], [29, 22], [29, 58], [29, 68], [29, 81], [29, 90], [29, 109], [29, 111], [29, 123], [29, 148], [29, 198], [30, 0], [30, 8], [30, 34], [30, 55], [30, 63], [30, 77], [30, 114], [30, 119], [30, 120], [30, 139], [30, 152], [30, 192], [31, 10], [31, 24], [31, 45], [31, 59], [31, 66], [31, 87], [31, 143], [31, 155], [31, 186], [32, 7], [32, 9], [32, 21], [32, 49], [32, 54], [32, 64], [32, 74], [32, 136], [32, 161], [32, 169], [32, 175], [33, 2], [33, 39], [33, 43], [33, 76], [33, 84], [33, 99], [33, 105], [33, 122], [33, 149], [33, 160], [33, 174], [33, 194], [34, 0], [34, 30], [34, 42], [34, 55], [34, 63], [34, 78], [34, 116], [34, 119], [34, 120], [34, 159], [34, 179], [34, 192], [35, 27], [35, 52], [35, 80], [35, 89], [35, 92], [35, 94], [35, 101], [35, 117], [35, 182], [35, 184], [35, 196], [36, 11], [36, 17], [36, 51], [36, 60], [36, 97], [36, 150], [36, 154], [36, 157], [36, 164], [37, 6], [37, 15], [37, 46], [37, 86], [37, 103], [37, 126], [37, 130], [37, 145], [37, 193], [38, 14], [38, 47], [38, 69], [38, 71], [38, 75], [38, 113], [38, 121], [38, 125], [38, 132], [38, 172], [38, 173], [38, 178], [38, 181], [38, 188], [38, 190], [39, 2], [39, 33], [39, 73], [39, 76], [39, 84], [39, 105], [39, 122], [39, 124], [39, 141], [39, 149], [39, 194], [40, 70], [40, 72], [40, 79], [40, 82], [40, 88], [40, 118], [40, 150], [40, 154], [40, 164], [40, 167], [41, 10], [41, 45], [41, 85], [41, 87], [41, 107], [41, 110], [41, 131], [41, 143], [41, 144], [41, 195], [42, 34], [42, 55], [42, 56], [42, 78], [42, 116], [42, 159], [42, 162], [42, 170], [42, 179], [43, 25], [43, 28], [43, 33], [43, 48], [43, 76], [43, 84], [43, 99], [43, 127], [43, 140], [43, 146], [43, 160], [43, 174], [43, 197], [44, 1], [44, 67], [44, 108], [44, 115], [44, 135], [44, 151], [44, 163], [44, 168], [44, 180], [44, 199], [45, 10], [45, 24], [45, 31], [45, 41], [45, 59], [45, 85], [45, 87], [45, 107], [45, 143], [45, 144], [45, 155], [45, 195], [46, 6], [46, 15], [46, 37], [46, 86], [46, 91], [46, 126], [46, 130], [46, 145], [46, 193], [47, 14], [47, 19], [47, 38], [47, 50], [47, 93], [47, 121], [47, 125], [47, 173], [47, 177], [47, 178], [47, 189], [48, 11], [48, 25], [48, 28], [48, 43], [48, 51], [48, 127], [48, 133], [48, 140], [48, 146], [48, 157], [48, 160], [48, 174], [48, 197], [49, 7], [49, 21], [49, 32], [49, 54], [49, 74], [49, 79], [49, 167], [49, 169], [49, 175], [49, 187], [50, 19], [50, 47], [50, 93], [50, 110], [50, 125], [50, 131], [50, 177], [50, 189], [50, 195], [51, 11], [51, 17], [51, 25], [51, 28], [51, 36], [51, 48], [51, 60], [51, 97], [51, 133], [51, 157], [51, 164], [52, 5], [52, 20], [52, 26], [52, 27], [52, 35], [52, 80], [52, 117], [52, 182], [53, 3], [53, 61], [53, 106], [53, 137], [53, 171], [54, 7], [54, 9], [54, 13], [54, 21], [54, 32], [54, 49], [54, 57], [54, 64], [54, 134], [54, 136], [54, 161], [54, 169], [54, 175], [55, 0], [55, 30], [55, 34], [55, 42], [55, 63], [55, 78], [55, 116], [55, 119], [55, 120], [55, 159], [55, 179], [55, 192], [56, 16], [56, 42], [56, 78], [56, 116], [56, 159], [56, 162], [56, 166], [56, 170], [56, 179], [57, 9], [57, 13], [57, 23], [57, 54], [57, 64], [57, 100], [57, 115], [57, 128], [57, 134], [57, 136], [57, 147], [57, 156], [57, 161], [58, 18], [58, 22], [58, 29], [58, 90], [58, 109], [58, 142], [58, 148], [58, 153], [58, 185], [58, 191], [58, 198], [59, 24], [59, 31], [59, 45], [59, 66], [59, 81], [59, 85], [59, 87], [59, 123], [59, 143], [59, 155], [59, 186], [60, 11], [60, 17], [60, 36], [60, 51], [60, 97], [60, 133], [60, 150], [60, 157], [60, 164], [61, 53], [61, 65], [61, 98], [61, 104], [61, 106], [61, 137], [61, 171], [62, 4], [62, 5], [62, 12], [62, 20], [62, 26], [62, 27], [62, 95], [62, 96], [62, 135], [62, 165], [62, 183], [62, 199], [63, 0], [63, 8], [63, 30], [63, 34], [63, 55], [63, 77], [63, 114], [63, 119], [63, 120], [63, 139], [63, 152], [63, 192], [64, 9], [64, 13], [64, 32], [64, 54], [64, 57], [64, 134], [64, 136], [64, 156], [64, 161], [64, 169], [64, 175], [65, 61], [65, 71], [65, 75], [65, 98], [65, 104], [65, 106], [65, 137], [66, 24], [66, 31], [66, 59], [66, 68], [66, 81], [66, 87], [66, 111], [66, 112], [66, 123], [66, 155], [66, 186], [67, 1], [67, 23], [67, 44], [67, 108], [67, 115], [67, 128], [67, 147], [67, 163], [67, 168], [67, 180], [68, 22], [68, 29], [68, 66], [68, 81], [68, 102], [68, 111], [68, 112], [68, 123], [68, 198], [69, 38], [69, 71], [69, 75], [69, 104], [69, 113], [69, 132], [69, 172], [69, 173], [69, 181], [69, 188], [69, 190], [70, 40], [70, 72], [70, 74], [70, 79], [70, 82], [70, 88], [70, 118], [70, 154], [70, 167], [70, 187], [71, 38], [71, 65], [71, 69], [71, 75], [71, 98], [71, 104], [71, 113], [71, 132], [71, 137], [71, 172], [71, 181], [71, 188], [71, 190], [72, 40], [72, 70], [72, 82], [72, 88], [72, 118], [72, 150], [72, 154], [72, 164], [73, 39], [73, 124], [73, 141], [73, 194], [74, 7], [74, 21], [74, 32], [74, 49], [74, 70], [74, 79], [74, 82], [74, 167], [74, 169], [74, 175], [74, 187], [75, 38], [75, 65], [75, 69], [75, 71], [75, 98], [75, 104], [75, 113], [75, 132], [75, 137], [75, 172], [75, 181], [75, 188], [75, 190], [76, 2], [76, 33], [76, 39], [76, 43], [76, 84], [76, 99], [76, 105], [76, 122], [76, 127], [76, 149], [76, 160], [76, 174], [77, 0], [77, 8], [77, 30], [77, 63], [77, 91], [77, 114], [77, 120], [77, 130], [77, 139], [77, 152], [77, 192], [77, 193], [78, 16], [78, 34], [78, 42], [78, 55], [78, 56], [78, 116], [78, 158], [78, 159], [78, 162], [78, 166], [78, 170], [78, 179], [79, 7], [79, 21], [79, 40], [79, 49], [79, 70], [79, 74], [79, 82], [79, 88], [79, 118], [79, 154], [79, 167], [79, 187], [80, 5], [80, 20], [80, 27], [80, 35], [80, 52], [80, 92], [80, 101], [80, 117], [80, 182], [80, 184], [80, 196], [81, 29], [81, 59], [81, 66], [81, 68], [81, 102], [81, 111], [81, 112], [81, 123], [81, 155], [81, 186], [81, 198], [82, 40], [82, 70], [82, 72], [82, 74], [82, 79], [82, 88], [82, 118], [82, 154], [82, 167], [82, 187], [83, 89], [83, 92], [83, 94], [83, 101], [83, 129], [83, 138], [83, 176], [83, 184], [84, 2], [84, 33], [84, 39], [84, 43], [84, 76], [84, 99], [84, 105], [84, 122], [84, 149], [84, 194], [85, 10], [85, 24], [85, 41], [85, 45], [85, 59], [85, 87], [85, 107], [85, 143], [85, 144], [85, 155], [86, 6], [86, 15], [86, 37], [86, 46], [86, 103], [86, 126], [86, 145], [87, 10], [87, 24], [87, 31], [87, 41], [87, 45], [87, 59], [87, 66], [87, 85], [87, 107], [87, 143], [87, 144], [87, 155], [87, 186], [88, 40], [88, 70], [88, 72], [88, 79], [88, 82], [88, 118], [88, 150], [88, 154], [88, 167], [89, 35], [89, 83], [89, 92], [89, 94], [89, 101], [89, 129], [89, 138], [89, 176], [89, 184], [89, 196], [90, 18], [90, 22], [90, 29], [90, 58], [90, 109], [90, 142], [90, 148], [90, 153], [90, 158], [90, 166], [90, 185], [90, 191], [91, 6], [91, 8], [91, 15], [91, 46], [91, 77], [91, 114], [91, 130], [91, 139], [91, 152], [91, 193], [92, 35], [92, 80], [92, 83], [92, 89], [92, 94], [92, 101], [92, 117], [92, 182], [92, 184], [92, 196], [93, 14], [93, 19], [93, 47], [93, 50], [93, 110], [93, 121], [93, 125], [93, 131], [93, 177], [93, 178], [93, 189], [93, 195], [94, 35], [94, 83], [94, 89], [94, 92], [94, 101], [94, 129], [94, 138], [94, 176], [94, 182], [94, 184], [94, 196], [95, 4], [95, 5], [95, 12], [95, 20], [95, 26], [95, 27], [95, 62], [95, 96], [95, 135], [95, 165], [95, 183], [95, 199], [96, 1], [96, 4], [96, 12], [96, 26], [96, 62], [96, 95], [96, 135], [96, 151], [96, 165], [96, 183], [96, 199], [97, 11], [97, 17], [97, 36], [97, 51], [97, 60], [97, 133], [97, 150], [97, 157], [97, 164], [98, 61], [98, 65], [98, 71], [98, 75], [98, 104], [98, 106], [98, 137], [98, 188], [98, 190], [99, 28], [99, 33], [99, 43], [99, 76], [99, 84], [99, 127], [99, 140], [99, 146], [99, 149], [99, 160], [99, 174], [99, 197], [100, 9], [100, 13], [100, 57], [100, 115], [100, 128], [100, 134], [100, 147], [100, 156], [101, 35], [101, 80], [101, 83], [101, 89], [101, 92], [101, 94], [101, 117], [101, 138], [101, 176], [101, 182], [101, 184], [101, 196], [102, 22], [102, 68], [102, 81], [102, 111], [102, 112], [102, 123], [102, 198], [103, 37], [103, 86], [103, 126], [103, 145], [104, 61], [104, 65], [104, 69], [104, 71], [104, 75], [104, 98], [104, 113], [104, 132], [104, 137], [104, 188], [104, 190], [105, 2], [105, 33], [105, 39], [105, 76], [105, 84], [105, 122], [105, 124], [105, 149], [105, 194], [106, 3], [106, 53], [106, 61], [106, 65], [106, 98], [106, 137], [106, 171], [107, 10], [107, 41], [107, 45], [107, 85], [107, 87], [107, 110], [107, 143], [107, 144], [107, 195], [108, 1], [108, 44], [108, 67], [108, 115], [108, 135], [108, 151], [108, 163], [108, 168], [108, 180], [108, 199], [109, 18], [109, 22], [109, 29], [109, 58], [109, 90], [109, 148], [109, 153], [109, 185], [109, 191], [109, 198], [110, 19], [110, 41], [110, 50], [110, 93], [110, 107], [110, 131], [110, 144], [110, 177], [110, 189], [110, 195], [111, 22], [111, 29], [111, 66], [111, 68], [111, 81], [111, 102], [111, 112], [111, 123], [111, 198], [112, 66], [112, 68], [112, 81], [112, 102], [112, 111], [112, 123], [112, 155], [112, 198], [113, 38], [113, 69], [113, 71], [113, 75], [113, 104], [113, 132], [113, 172], [113, 173], [113, 181], [113, 188], [113, 190], [114, 0], [114, 6], [114, 8], [114, 15], [114, 30], [114, 63], [114, 77], [114, 91], [114, 120], [114, 130], [114, 139], [114, 152], [114, 192], [114, 193], [115, 23], [115, 44], [115, 57], [115, 67], [115, 100], [115, 108], [115, 128], [115, 147], [115, 156], [115, 163], [115, 180], [116, 34], [116, 42], [116, 55], [116, 56], [116, 78], [116, 159], [116, 162], [116, 170], [116, 179], [117, 5], [117, 20], [117, 27], [117, 35], [117, 52], [117, 80], [117, 92], [117, 101], [117, 182], [117, 184], [117, 196], [118, 40], [118, 70], [118, 72], [118, 79], [118, 82], [118, 88], [118, 150], [118, 154], [118, 164], [118, 167], [119, 0], [119, 30], [119, 34], [119, 55], [119, 63], [119, 120], [119, 139], [119, 152], [119, 192], [120, 0], [120, 8], [120, 30], [120, 34], [120, 55], [120, 63], [120, 77], [120, 114], [120, 119], [120, 139], [120, 152], [120, 192], [121, 14], [121, 38], [121, 47], [121, 93], [121, 125], [121, 173], [121, 177], [121, 178], [121, 181], [122, 2], [122, 33], [122, 39], [122, 76], [122, 84], [122, 105], [122, 124], [122, 141], [122, 149], [122, 194], [123, 29], [123, 59], [123, 66], [123, 68], [123, 81], [123, 102], [123, 111], [123, 112], [123, 155], [123, 186], [123, 198], [124, 2], [124, 39], [124, 73], [124, 105], [124, 122], [124, 141], [124, 149], [124, 194], [125, 14], [125, 19], [125, 38], [125, 47], [125, 50], [125, 93], [125, 121], [125, 172], [125, 173], [125, 177], [125, 178], [125, 181], [125, 189], [126, 6], [126, 15], [126, 37], [126, 46], [126, 86], [126, 103], [126, 145], [127, 25], [127, 28], [127, 43], [127, 48], [127, 76], [127, 99], [127, 140], [127, 146], [127, 160], [127, 174], [127, 197], [128, 13], [128, 23], [128, 57], [128, 67], [128, 100], [128, 115], [128, 134], [128, 136], [128, 147], [128, 156], [128, 163], [128, 180], [129, 83], [129, 89], [129, 94], [129, 138], [129, 176], [130, 6], [130, 8], [130, 15], [130, 37], [130, 46], [130, 77], [130, 91], [130, 114], [130, 139], [130, 193], [131, 10], [131, 41], [131, 50], [131, 93], [131, 110], [131, 144], [131, 177], [131, 189], [131, 195], [132, 38], [132, 69], [132, 71], [132, 75], [132, 104], [132, 113], [132, 172], [132, 181], [132, 188], [132, 190], [133, 11], [133, 17], [133, 25], [133, 28], [133, 48], [133, 51], [133, 60], [133, 97], [133, 140], [133, 146], [133, 157], [133, 197], [134, 9], [134, 13], [134, 23], [134, 54], [134, 57], [134, 64], [134, 100], [134, 128], [134, 136], [134, 147], [134, 156], [134, 161], [135, 4], [135, 44], [135, 62], [135, 95], [135, 96], [135, 108], [135, 151], [135, 163], [135, 165], [135, 168], [135, 199], [136, 9], [136, 13], [136, 23], [136, 32], [136, 54], [136, 57], [136, 64], [136, 128], [136, 134], [136, 147], [136, 156], [136, 161], [137, 53], [137, 61], [137, 65], [137, 71], [137, 75], [137, 98], [137, 104], [137, 106], [137, 171], [137, 188], [137, 190], [138, 83], [138, 89], [138, 94], [138, 101], [138, 129], [138, 176], [139, 0], [139, 6], [139, 8], [139, 30], [139, 63], [139, 77], [139, 91], [139, 114], [139, 119], [139, 120], [139, 130], [139, 152], [139, 192], [139, 193], [140, 25], [140, 28], [140, 43], [140, 48], [140, 99], [140, 127], [140, 133], [140, 146], [140, 160], [140, 174], [140, 197], [141, 2], [141, 39], [141, 73], [141, 122], [141, 124], [141, 194], [142, 16], [142, 18], [142, 58], [142, 90], [142, 153], [142, 158], [142, 162], [142, 166], [142, 170], [142, 185], [142, 191], [143, 10], [143, 24], [143, 31], [143, 41], [143, 45], [143, 59], [143, 85], [143, 87], [143, 107], [143, 144], [143, 155], [144, 10], [144, 41], [144, 45], [144, 85], [144, 87], [144, 107], [144, 110], [144, 131], [144, 143], [144, 195], [145, 6], [145, 15], [145, 37], [145, 46], [145, 86], [145, 103], [145, 126], [146, 25], [146, 28], [146, 43], [146, 48], [146, 99], [146, 127], [146, 133], [146, 140], [146, 160], [146, 174], [146, 197], [147, 13], [147, 23], [147, 57], [147, 67], [147, 100], [147, 115], [147, 128], [147, 134], [147, 136], [147, 156], [147, 163], [147, 180], [148, 18], [148, 22], [148, 29], [148, 58], [148, 90], [148, 109], [148, 153], [148, 185], [148, 191], [148, 198], [149, 2], [149, 33], [149, 39], [149, 76], [149, 84], [149, 99], [149, 105], [149, 122], [149, 124], [149, 194], [150, 17], [150, 36], [150, 40], [150, 60], [150, 72], [150, 88], [150, 97], [150, 118], [150, 154], [150, 164], [151, 1], [151, 4], [151, 44], [151, 96], [151, 108], [151, 135], [151, 163], [151, 168], [151, 183], [151, 199], [152, 0], [152, 8], [152, 30], [152, 63], [152, 77], [152, 91], [152, 114], [152, 119], [152, 120], [152, 139], [152, 192], [153, 16], [153, 18], [153, 22], [153, 58], [153, 90], [153, 109], [153, 142], [153, 148], [153, 158], [153, 166], [153, 185], [153, 191], [154, 36], [154, 40], [154, 70], [154, 72], [154, 79], [154, 82], [154, 88], [154, 118], [154, 150], [154, 164], [154, 167], [155, 24], [155, 31], [155, 45], [155, 59], [155, 66], [155, 81], [155, 85], [155, 87], [155, 112], [155, 123], [155, 143], [155, 186], [156, 9], [156, 13], [156, 23], [156, 57], [156, 64], [156, 100], [156, 115], [156, 128], [156, 134], [156, 136], [156, 147], [156, 161], [157, 11], [157, 17], [157, 25], [157, 28], [157, 36], [157, 48], [157, 51], [157, 60], [157, 97], [157, 133], [157, 164], [158, 16], [158, 18], [158, 78], [158, 90], [158, 142], [158, 153], [158, 162], [158, 166], [158, 170], [158, 185], [158, 191], [159, 16], [159, 34], [159, 42], [159, 55], [159, 56], [159, 78], [159, 116], [159, 162], [159, 166], [159, 170], [159, 179], [160, 25], [160, 28], [160, 33], [160, 43], [160, 48], [160, 76], [160, 99], [160, 127], [160, 140], [160, 146], [160, 174], [160, 197], [161, 9], [161, 13], [161, 32], [161, 54], [161, 57], [161, 64], [161, 134], [161, 136], [161, 156], [161, 169], [161, 175], [162, 16], [162, 42], [162, 56], [162, 78], [162, 116], [162, 142], [162, 158], [162, 159], [162, 166], [162, 170], [162, 179], [163, 1], [163, 23], [163, 44], [163, 67], [163, 108], [163, 115], [163, 128], [163, 135], [163, 147], [163, 151], [163, 168], [163, 180], [163, 199], [164, 11], [164, 17], [164, 36], [164, 40], [164, 51], [164, 60], [164, 72], [164, 97], [164, 118], [164, 150], [164, 154], [164, 157], [165, 4], [165, 12], [165, 26], [165, 62], [165, 95], [165, 96], [165, 135], [165, 199], [166, 16], [166, 18], [166, 56], [166, 78], [166, 90], [166, 142], [166, 153], [166, 158], [166, 159], [166, 162], [166, 170], [166, 179], [166, 185], [166, 191], [167, 7], [167, 21], [167, 40], [167, 49], [167, 70], [167, 74], [167, 79], [167, 82], [167, 88], [167, 118], [167, 154], [167, 187], [168, 1], [168, 44], [168, 67], [168, 108], [168, 135], [168, 151], [168, 163], [168, 180], [168, 199], [169, 7], [169, 9], [169, 21], [169, 32], [169, 49], [169, 54], [169, 64], [169, 74], [169, 161], [169, 175], [169, 187], [170, 16], [170, 42], [170, 56], [170, 78], [170, 116], [170, 142], [170, 158], [170, 159], [170, 162], [170, 166], [170, 179], [171, 3], [171, 53], [171, 61], [171, 106], [171, 137], [172, 14], [172, 38], [172, 69], [172, 71], [172, 75], [172, 113], [172, 125], [172, 132], [172, 173], [172, 178], [172, 181], [172, 188], [172, 190], [173, 14], [173, 38], [173, 47], [173, 69], [173, 113], [173, 121], [173, 125], [173, 172], [173, 177], [173, 178], [173, 181], [174, 25], [174, 28], [174, 33], [174, 43], [174, 48], [174, 76], [174, 99], [174, 127], [174, 140], [174, 146], [174, 160], [174, 197], [175, 7], [175, 9], [175, 21], [175, 32], [175, 49], [175, 54], [175, 64], [175, 74], [175, 161], [175, 169], [175, 187], [176, 83], [176, 89], [176, 94], [176, 101], [176, 129], [176, 138], [176, 184], [176, 196], [177, 14], [177, 19], [177, 47], [177, 50], [177, 93], [177, 110], [177, 121], [177, 125], [177, 131], [177, 173], [177, 178], [177, 189], [178, 14], [178, 38], [178, 47], [178, 93], [178, 121], [178, 125], [178, 172], [178, 173], [178, 177], [178, 181], [179, 16], [179, 34], [179, 42], [179, 55], [179, 56], [179, 78], [179, 116], [179, 159], [179, 162], [179, 166], [179, 170], [180, 1], [180, 23], [180, 44], [180, 67], [180, 108], [180, 115], [180, 128], [180, 147], [180, 163], [180, 168], [181, 14], [181, 38], [181, 69], [181, 71], [181, 75], [181, 113], [181, 121], [181, 125], [181, 132], [181, 172], [181, 173], [181, 178], [181, 188], [181, 190], [182, 20], [182, 27], [182, 35], [182, 52], [182, 80], [182, 92], [182, 94], [182, 101], [182, 117], [182, 184], [182, 196], [183, 1], [183, 4], [183, 12], [183, 26], [183, 62], [183, 95], [183, 96], [183, 151], [183, 199], [184, 35], [184, 80], [184, 83], [184, 89], [184, 92], [184, 94], [184, 101], [184, 117], [184, 176], [184, 182], [184, 196], [185, 18], [185, 22], [185, 58], [185, 90], [185, 109], [185, 142], [185, 148], [185, 153], [185, 158], [185, 166], [185, 191], [186, 24], [186, 31], [186, 59], [186, 66], [186, 81], [186, 87], [186, 123], [186, 155], [187, 7], [187, 21], [187, 49], [187, 70], [187, 74], [187, 79], [187, 82], [187, 167], [187, 169], [187, 175], [188, 38], [188, 69], [188, 71], [188, 75], [188, 98], [188, 104], [188, 113], [188, 132], [188, 137], [188, 172], [188, 181], [188, 190], [189, 19], [189, 47], [189, 50], [189, 93], [189, 110], [189, 125], [189, 131], [189, 177], [189, 195], [190, 38], [190, 69], [190, 71], [190, 75], [190, 98], [190, 104], [190, 113], [190, 132], [190, 137], [190, 172], [190, 181], [190, 188], [191, 16], [191, 18], [191, 58], [191, 90], [191, 109], [191, 142], [191, 148], [191, 153], [191, 158], [191, 166], [191, 185], [192, 0], [192, 8], [192, 30], [192, 34], [192, 55], [192, 63], [192, 77], [192, 114], [192, 119], [192, 120], [192, 139], [192, 152], [193, 6], [193, 8], [193, 15], [193, 37], [193, 46], [193, 77], [193, 91], [193, 114], [193, 130], [193, 139], [194, 2], [194, 33], [194, 39], [194, 73], [194, 84], [194, 105], [194, 122], [194, 124], [194, 141], [194, 149], [195, 10], [195, 41], [195, 45], [195, 50], [195, 93], [195, 107], [195, 110], [195, 131], [195, 144], [195, 189], [196, 27], [196, 35], [196, 80], [196, 89], [196, 92], [196, 94], [196, 101], [196, 117], [196, 176], [196, 182], [196, 184], [197, 25], [197, 28], [197, 43], [197, 48], [197, 99], [197, 127], [197, 133], [197, 140], [197, 146], [197, 160], [197, 174], [198, 22], [198, 29], [198, 58], [198, 68], [198, 81], [198, 102], [198, 109], [198, 111], [198, 112], [198, 123], [198, 148], [199, 1], [199, 4], [199, 44], [199, 62], [199, 95], [199, 96], [199, 108], [199, 135], [199, 151], [199, 163], [199, 165], [199, 168], [199, 183]]
SELF.MAPPING
{0: set(), 1: set(), 2: {73}, 4: set(), 5: set(), 6: {103}, 7: set(), 8: set(), 9: set(), 10: set(), 11: set(), 12: set(), 13: set(), 14: set(), 15: set(), 16: set(), 17: set(), 18: set(), 19: set(), 20: set(), 21: set(), 22: set(), 23: set(), 24: set(), 25: set(), 26: set(), 27: set(), 28: set(), 29: set(), 30: set(), 31: set(), 32: set(), 33: set(), 34: set(), 35: set(), 36: set(), 37: set(), 38: set(), 39: set(), 40: set(), 41: set(), 42: set(), 43: set(), 44: set(), 45: set(), 46: set(), 47: set(), 48: set(), 49: set(), 50: set(), 51: set(), 52: set(), 53: {3}, 54: set(), 55: set(), 56: set(), 57: set(), 58: set(), 59: set(), 60: set(), 61: set(), 62: set(), 63: set(), 64: set(), 65: set(), 66: set(), 67: set(), 68: set(), 69: set(), 70: set(), 71: set(), 72: set(), 74: set(), 75: set(), 76: set(), 77: set(), 78: set(), 79: set(), 80: set(), 81: set(), 82: set(), 83: set(), 84: set(), 85: set(), 86: set(), 87: set(), 88: set(), 89: set(), 90: set(), 91: set(), 92: set(), 93: set(), 94: set(), 95: set(), 96: set(), 97: set(), 98: set(), 99: set(), 100: set(), 101: set(), 102: set(), 104: set(), 105: set(), 106: set(), 107: set(), 108: set(), 109: set(), 110: set(), 111: set(), 112: set(), 113: set(), 114: set(), 115: set(), 116: set(), 117: set(), 118: set(), 119: set(), 120: set(), 121: set(), 122: set(), 123: set(), 124: {73}, 125: set(), 126: set(), 127: set(), 128: set(), 129: set(), 130: set(), 131: set(), 132: set(), 133: set(), 134: set(), 135: set(), 136: set(), 137: set(), 138: set(), 139: set(), 140: set(), 141: set(), 142: set(), 143: set(), 144: set(), 145: {103}, 146: set(), 147: set(), 148: set(), 149: set(), 150: set(), 151: set(), 152: set(), 153: set(), 154: set(), 155: set(), 156: set(), 157: set(), 158: set(), 159: set(), 160: set(), 161: set(), 162: set(), 163: set(), 164: set(), 165: set(), 166: set(), 167: set(), 168: set(), 169: set(), 170: set(), 171: {3}, 172: set(), 173: set(), 174: set(), 175: set(), 176: set(), 177: set(), 178: set(), 179: set(), 180: set(), 181: set(), 182: set(), 183: set(), 184: set(), 185: set(), 186: set(), 187: set(), 188: set(), 189: set(), 190: set(), 191: set(), 192: set(), 193: set(), 194: set(), 195: set(), 196: set(), 197: set(), 198: set(), 199: set()}
PARENTS
[16, 1, 1, 3, 1, 1, 16, 1, 16, 1, 16, 1, 1, 1, 16, 16, 16, 1, 16, 16, 1, 1, 16, 1, 16, 1, 1, 1, 1, 16, 16, 16, 1, 1, 16, 1, 1, 16, 16, 1, 1, 16, 16, 1, 1, 16, 16, 16, 1, 1, 16, 1, 1, 16, 1, 16, 16, 1, 16, 16, 1, 16, 1, 16, 1, 16, 16, 1, 16, 16, 1, 16, 1, 73, 1, 16, 1, 16, 16, 1, 1, 16, 1, 1, 1, 16, 16, 16, 1, 1, 16, 16, 1, 16, 1, 1, 1, 1, 16, 1, 1, 1, 16, 103, 16, 1, 16, 16, 1, 16, 16, 16, 16, 16, 16, 1, 16, 1, 1, 16, 16, 16, 1, 16, 1, 16, 16, 1, 1, 1, 16, 16, 16, 1, 1, 1, 1, 16, 1, 16, 1, 1, 16, 16, 16, 16, 1, 1, 16, 1, 1, 1, 16, 16, 1, 16, 1, 1, 16, 16, 1, 1, 16, 1, 1, 1, 16, 1, 1, 1, 16, 16, 16, 16, 1, 1, 1, 16, 16, 16, 1, 16, 1, 1, 1, 16, 16, 1, 16, 16, 16, 16, 16, 16, 1, 16, 1, 1, 16, 1]
Parents len
200
CLUSTERS
{1, 3, 103, 73, 16}
RANKS
[24, 99, 11, 1, 6, 1, 1, 23, 1, 2, 16, 33, 1, 1, 38, 1, 98, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 8, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
3 73 103
v_to_k
{73: 124, 103: 145, 3: 171}
{16: {0, 6, 8, 10, 14, 15, 16, 18, 19, 22, 24, 29, 30, 31, 34, 37, 38, 41, 42, 45, 46, 47, 50, 53, 55, 56, 58, 59, 61, 63, 65, 66, 68, 69, 71, 75, 77, 78, 81, 85, 86, 87, 90, 91, 93, 98, 102, 104, 106, 107, 109, 110, 111, 112, 113, 114, 116, 119, 120, 121, 123, 125, 126, 130, 131, 132, 137, 139, 142, 143, 144, 145, 148, 152, 153, 155, 158, 159, 162, 166, 170, 171, 172, 173, 177, 178, 179, 181, 185, 186, 188, 189, 190, 191, 192, 193, 195, 198}, 1: {1, 2, 4, 5, 7, 9, 11, 12, 13, 17, 20, 21, 23, 25, 26, 27, 28, 32, 33, 35, 36, 39, 40, 43, 44, 48, 49, 51, 52, 54, 57, 60, 62, 64, 67, 70, 72, 74, 76, 79, 80, 82, 83, 84, 88, 89, 92, 94, 95, 96, 97, 99, 100, 101, 105, 108, 115, 117, 118, 122, 124, 127, 128, 129, 133, 134, 135, 136, 138, 140, 141, 146, 147, 149, 150, 151, 154, 156, 157, 160, 161, 163, 164, 165, 167, 168, 169, 174, 175, 176, 180, 182, 183, 184, 187, 194, 196, 197, 199}, 3: set(), 73: set(), 103: set()}
5
{0: {0, 6, 8, 10, 14, 15, 16, 18, 19, 22, 24, 29, 30, 31, 34, 37, 38, 41, 42, 45, 46, 47, 50, 53, 55, 56, 58, 59, 61, 63, 65, 66, 68, 69, 71, 75, 77, 78, 81, 85, 86, 87, 90, 91, 93, 98, 102, 104, 106, 107, 109, 110, 111, 112, 113, 114, 116, 119, 120, 121, 123, 125, 126, 130, 131, 132, 137, 139, 142, 143, 144, 145, 148, 152, 153, 155, 158, 159, 162, 166, 170, 171, 172, 173, 177, 178, 179, 181, 185, 186, 188, 189, 190, 191, 192, 193, 195, 198}, 1: {1, 2, 4, 5, 7, 9, 11, 12, 13, 17, 20, 21, 23, 25, 26, 27, 28, 32, 33, 35, 36, 39, 40, 43, 44, 48, 49, 51, 52, 54, 57, 60, 62, 64, 67, 70, 72, 74, 76, 79, 80, 82, 83, 84, 88, 89, 92, 94, 95, 96, 97, 99, 100, 101, 105, 108, 115, 117, 118, 122, 124, 127, 128, 129, 133, 134, 135, 136, 138, 140, 141, 146, 147, 149, 150, 151, 154, 156, 157, 160, 161, 163, 164, 165, 167, 168, 169, 174, 175, 176, 180, 182, 183, 184, 187, 194, 196, 197, 199}, 2: set(), 3: set(), 4: set()}
[0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ImplementingDbscan_files/figure-html/cell-9-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<ul>
<li>The code below is correct, make it efficient; remove v_to_k by chaning map_border, see if can directly do all the ops on the numpy array</li>
<li>Then move to GPU, perhaps needing to make less efficient on CPU first by doing all distance calculations (200*200, only need upper triangle) on CPU, then moving over…</li>
<li>Q: Do I need the mapping? EOD, just looking at parents…</li>
</ul>
<p>In this code, np.unique(a) returns an array of the unique elements in a, sorted in ascending order. Then, np.searchsorted(unique_elements, a) returns an array of the same shape as a, where each element of a is replaced by its index in unique_elements. This effectively remaps the elements of a to the range 0 to len(a)-1.</p>
</section>
</section>
<section id="final-cpu-implementation" class="level2">
<h2 class="anchored" data-anchor-id="final-cpu-implementation">Final CPU Implementation</h2>
<ul>
<li>Make a set of core points and a mapping of border points to their core.</li>
<li>Use union find to label the array of parents, forming clusters of core points or connected groups of core points.</li>
<li>Label border points with the parents of their corresponding core points.</li>
</ul>
<div id="cell-21" class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DbscanCustom:</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps, min_samples):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_samples <span class="op">=</span> min_samples</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.edges <span class="op">=</span> [] <span class="co"># for union find</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.core_points <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.border_to_core <span class="op">=</span> {}</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find(<span class="va">self</span>,i):</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      res <span class="op">=</span> i</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="va">self</span>.parents[res]<span class="op">!=</span>res:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[res] <span class="op">=</span> <span class="va">self</span>.parents[<span class="va">self</span>.parents[res]]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> <span class="va">self</span>.parents[res]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> union(<span class="va">self</span>, i,j):</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>      pi, pj <span class="op">=</span> <span class="va">self</span>.find(i), <span class="va">self</span>.find(j)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> pi <span class="op">==</span> pj: <span class="cf">return</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="va">self</span>.rank[pi] <span class="op">&gt;=</span> <span class="va">self</span>.rank[pj]:</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[pj] <span class="op">=</span> pi</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank[pi] <span class="op">+=</span> <span class="va">self</span>.rank[pj]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[pi] <span class="op">=</span> pj</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank[pj] <span class="op">+=</span> <span class="va">self</span>.rank[pi]</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Use union find to label the array of parents, forming clusters of core points or connected groups of core points.</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co">        Label border points with the parents of their corresponding core points.</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(X)))</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank <span class="op">=</span> [<span class="dv">1</span>]<span class="op">*</span><span class="bu">len</span>(X)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X <span class="op">=</span> X</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_points(X)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, j <span class="kw">in</span> <span class="va">self</span>.edges:</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="kw">in</span> <span class="va">self</span>.core_points <span class="kw">and</span> j <span class="kw">in</span> <span class="va">self</span>.core_points:</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.union(i,j)</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> border_idx, core_idx <span class="kw">in</span> <span class="va">self</span>.border_to_core.items():</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.parents[border_idx] <span class="op">=</span> <span class="va">self</span>.parents[core_idx]</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        result_orig_label <span class="op">=</span> np.array(<span class="va">self</span>.parents)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        unique_elements <span class="op">=</span> np.unique(result_orig_label)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        result_final_label <span class="op">=</span> np.searchsorted(unique_elements,result_orig_label)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result_final_label</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> label_points(<span class="va">self</span>, X):</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""1. Label the points as core, border, or noise."""</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X  <span class="op">=</span> X</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_core_points()</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_border_points()</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ignore the noise points, don't need them later</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_core_points(<span class="va">self</span>):</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X):</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.map_core(i):</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.core_points.add(i)</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_border_points(<span class="va">self</span>):</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>       <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(X):</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.core_points:</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.map_border(i)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_core(<span class="va">self</span>, i):</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A point is a core point if at least a specified number min_samples of neighboring points fall within eps radius"""</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>        num_within <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.X):</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> i <span class="op">==</span> j:</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(i,j) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.edges.append([i,j])</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>              num_within <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> num_within <span class="op">&gt;=</span> <span class="va">self</span>.min_samples:</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> map_border(<span class="va">self</span>, border_idx):</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""A border point is a point that has fewer than min_samples within eps, but lies within the radius eps of a core point"""</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>        min_dist <span class="op">=</span> <span class="va">self</span>.eps</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>        min_idx <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> core_idx <span class="kw">in</span> <span class="va">self</span>.core_points:</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> border_idx <span class="op">==</span> core_idx:</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="va">self</span>.distance(border_idx,core_idx) <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.distance(border_idx,core_idx) <span class="op">&lt;=</span> min_dist:</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>              min_dist <span class="op">=</span> <span class="va">self</span>.distance(border_idx,core_idx)</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>              min_idx <span class="op">=</span> core_idx</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> min_idx: <span class="va">self</span>.border_to_core[border_idx] <span class="op">=</span> min_idx</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> distance(<span class="va">self</span>,i,j):</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>      <span class="co">"""Distance between points of self.X with indices i and j"""</span></span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> np.sqrt(np.<span class="bu">sum</span>((<span class="va">self</span>.X[i]<span class="op">-</span><span class="va">self</span>.X[j])<span class="op">**</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-22" class="cell" data-executioninfo="{&quot;elapsed&quot;:1991,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705855972568,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="016344dd-93ad-4845-8794-df59ca64483e">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> make_moons(n_samples<span class="op">=</span><span class="dv">200</span>, noise<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>db_custom <span class="op">=</span> DbscanCustom(eps<span class="op">=</span><span class="fl">0.2</span>, min_samples<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>y_db <span class="op">=</span> db_custom.fit_predict(X)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature 1'</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Feature 2'</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ImplementingDbscan_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-23" class="cell" data-executioninfo="{&quot;elapsed&quot;:35229,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705856007790,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="9035bbe9-bae8-47c4-f1b8-88eb3b865747">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> db_custom.fit_predict(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>504 ms ± 220 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
</section>
<section id="naive-gpu-implementation-takes-more-time-than-cpu-implementation" class="level2">
<h2 class="anchored" data-anchor-id="naive-gpu-implementation-takes-more-time-than-cpu-implementation">Naive GPU implementation (takes more time than CPU implementation)</h2>
<ul>
<li>Get distance matrix</li>
<li>Label &lt; min_dist as 1 else 0</li>
<li>Sum (need min_samples +1 bc of 0 diag for dist between point and itself)</li>
<li>If sum &gt; min_dist+1, then add to core</li>
<li>Parallelize computation of cluster labels, not sure how…</li>
</ul>
<div id="cell-26" class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DbscanGPU:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps, min_samples):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_samples <span class="op">=</span> min_samples</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.core_points <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.border_to_core <span class="op">=</span> {}</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find(<span class="va">self</span>,i):</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>      res <span class="op">=</span> i</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="va">self</span>.parents[res]<span class="op">!=</span>res:</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[res] <span class="op">=</span> <span class="va">self</span>.parents[<span class="va">self</span>.parents[res]]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> <span class="va">self</span>.parents[res]</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> res</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> union(<span class="va">self</span>, i,j):</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>      pi, pj <span class="op">=</span> <span class="va">self</span>.find(i), <span class="va">self</span>.find(j)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> pi <span class="op">==</span> pj: <span class="cf">return</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="va">self</span>.rank[pi] <span class="op">&gt;=</span> <span class="va">self</span>.rank[pj]:</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[pj] <span class="op">=</span> pi</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank[pi] <span class="op">+=</span> <span class="va">self</span>.rank[pj]</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents[pi] <span class="op">=</span> pj</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank[pj] <span class="op">+=</span> <span class="va">self</span>.rank[pi]</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Use union find to label the array of parents, forming clusters of core points or connected groups of core points.</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Label border points with the parents of their corresponding core points.</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.parents <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="bu">len</span>(X)))</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rank <span class="op">=</span> [<span class="dv">1</span>]<span class="op">*</span><span class="bu">len</span>(X)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X <span class="op">=</span> X</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.label_points(X)</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">#note self.dists is a square matrix</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(<span class="va">self</span>.dists)):</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(<span class="va">self</span>.dists)):</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.core_points[i] <span class="kw">and</span> <span class="va">self</span>.core_points[j] <span class="kw">and</span> <span class="va">self</span>.dists[i,j] <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>              <span class="va">self</span>.union(i,j)</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> border_idx, core_idx <span class="kw">in</span> <span class="va">self</span>.border_to_core.items():</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.parents[border_idx] <span class="op">=</span> <span class="va">self</span>.parents[core_idx]</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>        result_orig_label <span class="op">=</span> np.array(<span class="va">self</span>.parents)</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        unique_elements <span class="op">=</span> np.unique(result_orig_label)</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>        result_final_label <span class="op">=</span> np.searchsorted(unique_elements,result_orig_label)</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result_final_label</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> label_points(<span class="va">self</span>, X):</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""1. Label the points as core, border, or noise."""</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.X  <span class="op">=</span> X</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.calc_distances()</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_core_points()</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.get_border_points()</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ignore the noise points, don't need them later</span></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_core_points(<span class="va">self</span>):</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.core_points <span class="op">=</span> torch.<span class="bu">sum</span>(<span class="va">self</span>.dists<span class="op">&lt;=</span><span class="va">self</span>.eps,dim <span class="op">=</span> <span class="dv">1</span>)<span class="op">&gt;</span><span class="va">self</span>.min_samples</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_border_points(<span class="va">self</span>):</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.border_points <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.core_points):</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> x: <span class="co">#if False</span></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>          <span class="va">self</span>.border_to_core[i]<span class="op">=</span><span class="va">self</span>.dists[i][i<span class="op">+</span><span class="dv">1</span>:].argmin().item() <span class="op">+</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> calc_distances(<span class="va">self</span>):</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>      <span class="co">"""Calculate the distance matrix between a point and every other point"""</span></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.dists<span class="op">=</span>(<span class="va">self</span>.X[<span class="va">None</span>,:,:]<span class="op">-</span><span class="va">self</span>.X[:,<span class="va">None</span>,:]).norm(dim<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-27" class="cell" data-executioninfo="{&quot;elapsed&quot;:1439,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705856087452,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="907a491a-f496-4096-f2cb-fe80a7b7aabb">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> <span class="bu">map</span>(torch.tensor,make_moons(n_samples<span class="op">=</span><span class="dv">200</span>, noise<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>db_custom_gpu <span class="op">=</span> DbscanGPU(eps<span class="op">=</span><span class="fl">0.2</span>, min_samples<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>y_db <span class="op">=</span> db_custom_gpu.fit_predict(X)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature 1'</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Feature 2'</span>)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ImplementingDbscan_files/figure-html/cell-14-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-28" class="cell" data-executioninfo="{&quot;elapsed&quot;:45572,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705856133020,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="7dc261df-0a56-4e07-8635-3b8a25be81bd">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> db_custom_gpu.fit_predict(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>652 ms ± 52.1 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
</section>
<section id="simple-optimized-gpu-implementation" class="level2">
<h2 class="anchored" data-anchor-id="simple-optimized-gpu-implementation">Simple optimized GPU implementation</h2>
<p>GitHub Copilot Your DBSCAN implementation looks quite good, but there are a few areas where it could be improved for better GPU utilization:</p>
<p>Batching distance calculations: Calculating pairwise distances can be memory-intensive for large datasets. You can batch these calculations to reduce memory usage.</p>
<p>Avoiding Python loops: Python loops are slow and cannot be parallelized on a GPU. You should replace the loops in fit_predict and get_border_points with vectorized operations.</p>
<p>Using in-place operations: In-place operations can reduce memory usage and improve performance. For example, you can use torch.add_ instead of + to update self.rank.</p>
<div id="cell-31" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DbscanGPU:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps, min_samples):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_samples <span class="op">=</span> min_samples</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate pairwise distances in batches to save memory</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        dists <span class="op">=</span> torch.cdist(X, X)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find core points</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        core_points <span class="op">=</span> (dists <span class="op">&lt;=</span> <span class="va">self</span>.eps).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>) <span class="op">&gt;=</span> <span class="va">self</span>.min_samples</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Label each point with its own index initially</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> torch.arange(<span class="bu">len</span>(X), device<span class="op">=</span>X.device)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Union-find for core points</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(X)):</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> core_points[i]:</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(X)):</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> core_points[j] <span class="kw">and</span> dists[i, j] <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Find the roots of i and j</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>                        root_i <span class="op">=</span> <span class="va">self</span>.find(labels, i)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>                        root_j <span class="op">=</span> <span class="va">self</span>.find(labels, j)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Union i and j by assigning the smaller label to the larger one</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> root_i <span class="op">&lt;</span> root_j:</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                            labels[root_j] <span class="op">=</span> root_i</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>                            labels[root_i] <span class="op">=</span> root_j</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign each non-core point to the same cluster as its nearest core point</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(X)):</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> core_points[i]:</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>                labels[i] <span class="op">=</span> labels[dists[i, core_points].argmin()]</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert labels to consecutive integers starting from 0</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        _, labels <span class="op">=</span> torch.unique(labels, return_inverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> labels.cpu().numpy()</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find(labels, i):</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> labels[i] <span class="op">!=</span> i:</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>            labels[i] <span class="op">=</span> DbscanGPU.find(labels, labels[i])</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> labels[i]</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-32" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DbscanGPU:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, eps, min_samples):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.eps <span class="op">=</span> eps</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.min_samples <span class="op">=</span> min_samples</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit_predict(<span class="va">self</span>, X):</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate pairwise distances in batches to save memory</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>        dists <span class="op">=</span> torch.cdist(X, X)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find core points</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        core_points <span class="op">=</span> (dists <span class="op">&lt;=</span> <span class="va">self</span>.eps).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>) <span class="op">&gt;=</span> <span class="va">self</span>.min_samples</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Label each point with its own index initially</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> torch.arange(<span class="bu">len</span>(X), device<span class="op">=</span>X.device)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Union-find for core points</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(X)):</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> core_points[i]:</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(X)):</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> core_points[j] <span class="kw">and</span> dists[i, j] <span class="op">&lt;=</span> <span class="va">self</span>.eps:</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Find the roots of i and j</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>                        root_i <span class="op">=</span> <span class="va">self</span>.find(labels, i)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>                        root_j <span class="op">=</span> <span class="va">self</span>.find(labels, j)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Union i and j by assigning the smaller label to the larger one</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> root_i <span class="op">&lt;</span> root_j:</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>                            labels[root_j] <span class="op">=</span> root_i</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">else</span>:</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>                            labels[root_i] <span class="op">=</span> root_j</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign each non-core point to the same cluster as its nearest core point</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(X)):</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> core_points[i]:</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>                labels[i] <span class="op">=</span> labels[dists[i, core_points].argmin()]</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert labels to consecutive integers starting from 0</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        _, labels <span class="op">=</span> torch.unique(labels, return_inverse<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> labels.cpu().numpy()</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">@staticmethod</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find(labels, i):</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> labels[i] <span class="op">!=</span> i:</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>            labels[i] <span class="op">=</span> DbscanGPU.find(labels, labels[i])</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> labels[i]</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># @staticmethod</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># def find(labels, i):</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     root = i</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     while labels[root] != root:</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         root = labels[root]</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     # Path compression</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     while labels[i] != i:</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         parent = labels[i]</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         labels[i] = root</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">#         i = parent</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">#     return root</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-33" class="cell" data-executioninfo="{&quot;elapsed&quot;:805,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705857741935,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="2a249cbe-8950-4510-a4ad-11743bbae68f">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>X, y <span class="op">=</span> <span class="bu">map</span>(torch.tensor,make_moons(n_samples<span class="op">=</span><span class="dv">200</span>, noise<span class="op">=</span><span class="fl">0.05</span>, random_state<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>db_custom_gpu <span class="op">=</span> DbscanGPU(eps<span class="op">=</span><span class="fl">0.2</span>, min_samples<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>y_db <span class="op">=</span> db_custom_gpu.fit_predict(X)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature 1'</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Feature 2'</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ImplementingDbscan_files/figure-html/cell-18-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-34" class="cell" data-executioninfo="{&quot;elapsed&quot;:23652,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705857766718,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="dd36434e-41cd-477f-d3b9-28aceb79ba2b">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> db_custom_gpu.fit_predict(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>336 ms ± 45 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<div id="cell-35" class="cell" data-executioninfo="{&quot;elapsed&quot;:247,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705856579823,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="14a3609f-1234-4cb2-9534-616f11648f81">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>(<span class="dv">329</span><span class="op">/</span><span class="dv">504</span>)<span class="op">*</span><span class="dv">100</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>65.27777777777779</code></pre>
</div>
</div>
</section>
<section id="out-of-the-box-optimized-dbscan-implementation" class="level2">
<h2 class="anchored" data-anchor-id="out-of-the-box-optimized-dbscan-implementation">Out-of-the box optimized DBSCAN implementation</h2>
<div id="cell-37" class="cell" data-executioninfo="{&quot;elapsed&quot;:235310,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705857353028,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="18e48a1f-7a7f-4d17-92a2-d5886788ec86" data-execution_count="1">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install <span class="op">\</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="op">--</span>extra<span class="op">-</span>index<span class="op">-</span>url<span class="op">=</span>https:<span class="op">//</span>pypi.nvidia.com <span class="op">\</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    cudf<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> dask<span class="op">-</span>cudf<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> cuml<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> <span class="op">\</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    cugraph<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> cuspatial<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> cuproj<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> <span class="op">\</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    cuxfilter<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> cucim<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> pylibraft<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span> <span class="op">\</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    raft<span class="op">-</span>dask<span class="op">-</span>cu12<span class="op">==</span><span class="fl">23.12</span>.<span class="op">*</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-38" class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> cuml <span class="im">import</span> DBSCAN <span class="im">as</span> cuml</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-39" class="cell" data-executioninfo="{&quot;elapsed&quot;:1004,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705857486127,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="819ad2e3-dd3b-4850-ebe5-6750f5c6de6e">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>db_gpu_opt <span class="op">=</span> DBSCAN(eps<span class="op">=</span><span class="fl">0.2</span>, min_samples<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>y_db <span class="op">=</span> db_gpu_opt.fit_predict(X)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">0</span>],</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">0</span>, <span class="dv">1</span>],</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'black'</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>plt.scatter(X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            X[y_db <span class="op">==</span> <span class="dv">1</span>, <span class="dv">1</span>],</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            c<span class="op">=</span><span class="st">'lightblue'</span>,</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>            edgecolor<span class="op">=</span><span class="st">'red'</span>,</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>            marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>            s<span class="op">=</span><span class="dv">40</span>,</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Cluster 1'</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Feature 1'</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Feature 2'</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="ImplementingDbscan_files/figure-html/cell-23-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-40" class="cell" data-executioninfo="{&quot;elapsed&quot;:689,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705857532882,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="4ad9b564-7561-4ab1-812b-89f0154393b0">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>timeit <span class="op">-</span>n <span class="dv">10</span> db_gpu_opt.fit_predict(X)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5.7 ms ± 858 µs per loop (mean ± std. dev. of 7 runs, 10 loops each)</code></pre>
</div>
</div>
<ul>
<li>Almost 100x faster on T4!</li>
</ul>
<div id="cell-42" class="cell" data-executioninfo="{&quot;elapsed&quot;:9,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705223,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="4842a26b-5da1-4ca0-e7e8-8e6ecbbbd219">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> torch.tensor([[<span class="dv">1</span>, <span class="dv">2</span>],[<span class="dv">3</span>, <span class="dv">4</span>], [<span class="dv">5</span>, <span class="dv">6</span>]])</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>X</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>n,m <span class="op">=</span> X.shape</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>X[<span class="va">None</span>,:,:]<span class="op">-</span>X[:,<span class="va">None</span>,:]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>tensor([[[ 0,  0],
         [ 2,  2],
         [ 4,  4]],

        [[-2, -2],
         [ 0,  0],
         [ 2,  2]],

        [[-4, -4],
         [-2, -2],
         [ 0,  0]]])</code></pre>
</div>
</div>
<div id="cell-43" class="cell" data-executioninfo="{&quot;elapsed&quot;:228,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705444,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="d011d422-9cac-4114-ff7f-09eb3d40d27c">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>X[<span class="va">None</span>,:,:].<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>tensor([[[1., 2.],
         [3., 4.],
         [5., 6.]]])</code></pre>
</div>
</div>
<div id="cell-44" class="cell" data-executioninfo="{&quot;elapsed&quot;:21,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705444,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="a51fcbff-12b0-4978-9b85-0bf487d0f78c">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>X[:,<span class="va">None</span>,:].<span class="bu">float</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>tensor([[[1., 2.]],

        [[3., 4.]],

        [[5., 6.]]])</code></pre>
</div>
</div>
<div id="cell-45" class="cell" data-executioninfo="{&quot;elapsed&quot;:19,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705444,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="5b62244a-8a5c-4abe-f828-d4059bc0a25c">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>out<span class="op">=</span>(X[<span class="va">None</span>,:,:].<span class="bu">float</span>()<span class="op">-</span>X[:,<span class="va">None</span>,:].<span class="bu">float</span>()).norm(dim<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>out</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>tensor([[0.0000, 2.8284, 5.6569],
        [2.8284, 0.0000, 2.8284],
        [5.6569, 2.8284, 0.0000]])</code></pre>
</div>
</div>
<div id="cell-46" class="cell" data-executioninfo="{&quot;elapsed&quot;:18,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705445,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="8d17b20a-8b59-4967-a9d7-c5f00a5c79ac">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>eps<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>(out <span class="op">&lt;=</span> <span class="fl">0.2</span>).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>tensor([1, 1, 1])</code></pre>
</div>
</div>
<div id="cell-47" class="cell" data-executioninfo="{&quot;elapsed&quot;:13,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705445,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="5f1b8b74-07eb-4698-e825-bae6e9b1c17b">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>X.shape, X[<span class="va">None</span>,:,:].shape, X[:,<span class="va">None</span>,:].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>(torch.Size([3, 2]), torch.Size([1, 3, 2]), torch.Size([3, 1, 2]))</code></pre>
</div>
</div>
<div id="cell-48" class="cell" data-executioninfo="{&quot;elapsed&quot;:9,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705446,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="b18c75ad-cc88-4c55-d1df-963e02457cc4">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>(X[<span class="va">None</span>,:,:,<span class="va">None</span>].<span class="bu">float</span>()<span class="op">-</span>X[:,:,<span class="va">None</span>].<span class="bu">float</span>()).norm(dim<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>tensor([[[0.],
         [0.],
         [0.]]])</code></pre>
</div>
</div>
<div id="cell-49" class="cell" data-executioninfo="{&quot;elapsed&quot;:272,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705711,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="c6173779-6f7b-4453-d594-c440b977b7b9">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>math.sqrt((<span class="dv">1</span><span class="op">-</span><span class="dv">6</span>)<span class="op">**</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>5.0</code></pre>
</div>
</div>
<div id="cell-50" class="cell" data-executioninfo="{&quot;elapsed&quot;:17,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705711,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="8f618aca-979c-46e6-e7a8-0e5644bc010b">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>X[<span class="va">None</span>,:,:].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>torch.Size([1, 3, 2])</code></pre>
</div>
</div>
<div id="cell-51" class="cell" data-executioninfo="{&quot;elapsed&quot;:14,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705711,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="3fd55282-052d-493a-c4c0-cff897ac05e7">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>X.T[:,:,<span class="va">None</span>].shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>torch.Size([2, 3, 1])</code></pre>
</div>
</div>
<div id="cell-52" class="cell" data-executioninfo="{&quot;elapsed&quot;:12,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705711,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="9f03aad7-cfd3-4deb-d437-6be60c4fbaec">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>torch.sqrt(torch.<span class="bu">sum</span>((X[<span class="va">None</span>,:,:]<span class="op">-</span> X.T[:,:,<span class="va">None</span>]) <span class="op">**</span> <span class="dv">2</span>, dim<span class="op">=</span>(<span class="dv">1</span>,)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>tensor([[0.0000, 1.7321],
        [1.7321, 0.0000]])</code></pre>
</div>
</div>
<div id="cell-53" class="cell" data-executioninfo="{&quot;elapsed&quot;:9,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705711,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="d979dc9f-f52e-4e76-e493-8459354116a4">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>torch.sqrt(torch.<span class="bu">sum</span>((X[<span class="va">None</span>,:,:]<span class="op">-</span> X.T[:,:,<span class="va">None</span>]) <span class="op">**</span> <span class="dv">2</span>,dim<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>tensor(2.4495)</code></pre>
</div>
</div>
<div id="cell-54" class="cell" data-executioninfo="{&quot;elapsed&quot;:7,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846705711,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="73e95535-1995-4110-88a7-56c8aa6615a6">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pairwise_distance(matrix):</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expand dims to allow broadcasting</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    expanded_a <span class="op">=</span> matrix.unsqueeze(<span class="dv">1</span>)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    expanded_b <span class="op">=</span> matrix.unsqueeze(<span class="dv">0</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute pairwise distance using Euclidean distance formula</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> torch.sqrt(torch.<span class="bu">sum</span>((expanded_a <span class="op">-</span> expanded_b) <span class="op">**</span> <span class="dv">2</span>, dim<span class="op">=-</span><span class="dv">1</span>))</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> distances</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the function</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>matrix <span class="op">=</span> torch.tensor([[<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>, <span class="dv">4</span>], [<span class="dv">5</span>, <span class="dv">6</span>]], dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>distances <span class="op">=</span> pairwise_distance(matrix)</span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(distances)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[0.0000, 2.8284, 5.6569],
        [2.8284, 0.0000, 2.8284],
        [5.6569, 2.8284, 0.0000]])</code></pre>
</div>
</div>
<div id="cell-55" class="cell" data-executioninfo="{&quot;elapsed&quot;:169,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705849121865,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="a2ff3ae6-e849-4f19-8b41-f3e1f97dbaf6">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pairwise_distance(matrix):</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expand dims to allow broadcasting</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    expanded_a <span class="op">=</span> matrix[:,<span class="va">None</span>,:]</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>    expanded_b <span class="op">=</span> matrix[<span class="va">None</span>,:,:]</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute pairwise distance using Euclidean distance formula</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    distances <span class="op">=</span> torch.sqrt(torch.<span class="bu">sum</span>((expanded_a <span class="op">-</span> expanded_b) <span class="op">**</span> <span class="dv">2</span>, dim<span class="op">=-</span><span class="dv">1</span>))</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> distances</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Test the function</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>matrix <span class="op">=</span> torch.tensor([[<span class="dv">1</span>, <span class="dv">2</span>], [<span class="dv">3</span>, <span class="dv">4</span>], [<span class="dv">5</span>, <span class="dv">6</span>]], dtype<span class="op">=</span>torch.<span class="bu">float</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>distances <span class="op">=</span> pairwise_distance(matrix)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(distances)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor([[0.0000, 2.8284, 5.6569],
        [2.8284, 0.0000, 2.8284],
        [5.6569, 2.8284, 0.0000]])</code></pre>
</div>
</div>
<div id="cell-56" class="cell" data-executioninfo="{&quot;elapsed&quot;:5,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705851222384,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="7b7bfe2b-c3cf-4e97-a2bc-2290114ebc32">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>distances[<span class="dv">1</span>].argmin().item()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="98">
<pre><code>1</code></pre>
</div>
</div>
<div id="cell-57" class="cell" data-executioninfo="{&quot;elapsed&quot;:130,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705849127977,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="3e342b15-3186-4dfc-8ac1-3ddc8c76c035">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>distances[<span class="dv">1</span>,<span class="dv">2</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>tensor(2.8284)</code></pre>
</div>
</div>
<div id="cell-58" class="cell" data-executioninfo="{&quot;elapsed&quot;:139,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705846860460,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="89955a6b-3bfb-4c63-c16f-5bdac18d71a9">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>math.sqrt((<span class="dv">1</span><span class="op">-</span><span class="dv">5</span>)<span class="op">**</span><span class="dv">2</span><span class="op">+</span>(<span class="dv">2</span><span class="op">-</span><span class="dv">6</span>)<span class="op">**</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>5.656854249492381</code></pre>
</div>
</div>
<div id="cell-59" class="cell" data-executioninfo="{&quot;elapsed&quot;:8,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1705847168235,&quot;user&quot;:{&quot;displayName&quot;:&quot;Dmitriy Popov-Velasco&quot;,&quot;userId&quot;:&quot;15125003632712864223&quot;},&quot;user_tz&quot;:300}" data-outputid="84404cb4-1391-4278-cd02-c7a3a46d8fdb">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>distances <span class="op">=</span> torch.tensor([[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">2</span>],[<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">3</span>],[<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1</span>]])</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>torch.<span class="bu">sum</span>(distances<span class="op">&gt;</span><span class="dv">1</span>,dim<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>tensor([2, 3, 1])</code></pre>
</div>
</div>
</section>
<section id="cuml-dbscan-naive-gpu-dbscan" class="level2">
<h2 class="anchored" data-anchor-id="cuml-dbscan-naive-gpu-dbscan">cuML DBSCAN &gt; Naive GPU DBSCAN</h2>
<p>Spatial indexing is a common technique used to speed up DBSCAN implementations. The main idea is to organize the data in such a way that queries about the spatial proximity of data points can be answered more efficiently.</p>
<p>In the context of DBSCAN, one of the most computationally expensive parts of the algorithm is finding all points within a certain distance (eps) of a given point. This is because, in a naive implementation, you would need to calculate the distance between the given point and every other point in the dataset, which is an O(n) operation.</p>
<p>Spatial indexes, such as k-d trees or R-trees, can significantly speed up this operation. These data structures partition the data space into regions, and points within the same region are likely to be close to each other. This allows the algorithm to quickly eliminate many points that are too far away from the given point without having to calculate the exact distance.</p>
<p>In the cuML implementation of DBSCAN, the use of spatial indexing is abstracted away by the underlying CUDA libraries. The VertexDeg::run function, which calculates the degree of each vertex in the adjacency graph representation of the dataset, is likely where the spatial indexing is used. Different algorithms can be used for this calculation based on the algo parameter, some of which may use spatial indexing.</p>
<p>However, it’s important to note that while spatial indexing can significantly speed up DBSCAN on CPUs, the situation is a bit different on GPUs. Due to the parallel nature of GPUs, sometimes a brute-force approach (calculating the distance between all pairs of points) can be faster than building and querying a spatial index. The optimal approach depends on the specific characteristics of the GPU and the dataset.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dpopovvelasco\.dev");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><span class="faux-block">© 2024 Dmitriy Popov-Velasco CC BY-SA 4.0</span></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>