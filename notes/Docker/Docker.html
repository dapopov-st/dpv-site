<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2024-08-01">
<meta name="description" content="Docker notes">

<title>Docker notes – Dmitriy Popov-Velasco</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e635ef9634ac7a83e3238eed2d3e09f4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Dmitriy Popov-Velasco</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../posts.html"> 
<span class="menu-text">Blogs</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../notes.html"> 
<span class="menu-text">Notes</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/dapvelasco"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:dpopovvelasco@gmail.com"> <i class="bi bi-envelope" role="img" aria-label="email">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/dapopov-st"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Docker notes</h1>
                  <div>
        <div class="description">
          Docker notes
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">Programming</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 1, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<ul>
<li><p>Containers are isolated environments using the kernel of your host OS</p>
<ul>
<li>They are running instances of images which are “blueprints” or snapshots for containers</li>
<li>They are build in layers, which can be used across multiple images</li>
</ul></li>
<li><p>Images ~ Classes: Specified via Dockerfile</p></li>
<li><p>Containers ~ Objects: instantiations of images</p></li>
<li><p>Dockerfile: Text document containing commands user would call on the command line to assemble an image</p></li>
<li><p>Basic Dockerfile launching a shell with Python 3.8 available:</p></li>
</ul>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-3-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<ul>
<li><p>Anything below a changed line runs so it’s important to specify frequently-changing commands at the bottom of the file, non frequently used at the top. Reduces Docker runtime</p></li>
<li><p>Each command creates a new <em>layer</em>. Keeping the number of layers as low as possible will keep image size down -&gt; Use &nbsp;as shown above for ENV and &amp;&amp; for RUN + follow install with multiple things to install</p></li>
<li><p>Dockerfile definitions:</p></li>
</ul>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-6-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<section id="docker-abcs-running-a-simple-application-with-docker-volume-to-persist-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="docker-abcs-running-a-simple-application-with-docker-volume-to-persist-data">Docker ABCs: Running a simple application with Docker volume to persist data</h2>
<ul>
<li>Step 1: Create Dockerfile</li>
</ul>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-9-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<ul>
<li>Step 2: Create simple Python application</li>
</ul>
<div id="cell-11" class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># app.py</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a file and write some content to it</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">"output.txt"</span>, <span class="st">"a"</span>) <span class="im">as</span> f:</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    f.write(<span class="ss">f"Hello from Docker!</span><span class="ch">\n</span><span class="ss">Time: </span><span class="sc">{</span>time<span class="sc">.</span>time()<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"File written successfully."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><p>Step 3: Create requirements.txt to specify Python dependencies.</p></li>
<li><p>Step 4: Build the Docker image using Dockerfile and name it (here my-python-app)</p></li>
</ul>
<div id="cell-14" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>docker build <span class="op">-</span>t my<span class="op">-</span>python<span class="op">-</span>app .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Step 5: Run the Docker image with a volume</li>
</ul>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>docker run <span class="op">-</span>v $(pwd):<span class="op">/</span>app my<span class="op">-</span>python<span class="op">-</span>app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Can also run interactively and run from shell from inside a container:
<ul>
<li>When run the container, application will write message + time</li>
<li>Can run <code>python app.py</code> from inside the container, which will keep appending to the file</li>
<li><code>exit</code> and the changes will persist</li>
</ul></li>
</ul>
<div id="cell-18" class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>docker run <span class="op">-</span>it <span class="op">--</span>name my<span class="op">-</span>python<span class="op">-</span>app<span class="op">-</span>container <span class="op">-</span>v $(pwd):<span class="op">/</span>app my<span class="op">-</span>python<span class="op">-</span>app <span class="op">/</span><span class="bu">bin</span><span class="op">/</span>bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>Don’t forget to remove the container with <code>docker rm my-python-app-container</code>, or <em>better yet</em>, run with rm flag as below:</li>
</ul>
<div id="cell-20" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>bash</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>docker run <span class="op">--</span>rm <span class="op">-</span>it <span class="op">--</span>name my<span class="op">-</span>python<span class="op">-</span>app<span class="op">-</span>container <span class="op">-</span>v $(pwd):<span class="op">/</span>app my<span class="op">-</span>python<span class="op">-</span>app <span class="op">/</span><span class="bu">bin</span><span class="op">/</span>bash</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="following-learn-docker-in-a-month-of-lunches-by-elton-stoneman" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="following-learn-docker-in-a-month-of-lunches-by-elton-stoneman">Following <em>Learn Docker in a Month of Lunches</em> by Elton Stoneman</h2>
<section id="ch.2-understanding-docker-and-hello-world" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="ch.2-understanding-docker-and-hello-world">Ch.2: Understanding Docker and Hello World</h3>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-23-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<ul>
<li><p>Note that each container shares the operating system of the host computer!</p></li>
<li><p><code>docker container ls</code>: lists running containers; add –all to see exited containers</p></li>
<li><p><code>docker container logs {start_of_container_id}</code>: displays log entries collected by container</p></li>
<li><p><code>docker container stats {start_of_container_id}</code>: displays stats about CPU, memory, network, and disk the container is using</p></li>
<li><p><code>docker container inspect {start_of_container_id}</code>: displays low level details of the container</p></li>
<li><p>Notes on ‘Exited’ containers: i.) They no longer consume CPU time or memory, ii.) They still take up disk space and can be restarted, can also check logs and copy files to/from container’s filesystem.</p></li>
<li><p><code>docker container run --detach --publish 8088:80 diamol/ch02-hello-diamol-web</code>:</p>
<ul>
<li>–detach starts the container in the background and shows container id</li>
<li>–publish publishes a port from the container to the computer. When Docker is installed, it injects itself into computer’s networking layer. Publishing means Docker will listen to network traffic on computer port and send it to the container.<br>
<img src="Docker_files/figure-html/cell-26-1-image.png" class="img-fluid" alt="image.png"></li>
</ul></li>
<li><p><code>docker container rm --force $(docker container ls --all --quiet)</code>: remove all containers, use with caution since it does not ask for confirmation.</p></li>
<li><p>CLI sends requests to Docker API, which then interacts with the Docker Engine.</p></li>
<li><p>Exercise: replace index.html inside the container to change website front matter.</p>
<ul>
<li>Used <code>docker container</code> to find <code>cp</code> from among the available commands.</li>
<li>Used <code>docker exec jovial_meninsky ls -R</code> to list container’s file system info.</li>
<li>Had to find absolute path since relative paths would not work -&gt; <code>docker exec jovial_meninsky pwd</code> for path prefix</li>
<li>Solution: <code>docker container cp diamol/ch02/exercises/hello-diamol-web/html/index.html jovial_meninsky:/usr/local/apache2/htdocs/index.html</code> Successfully copied 2.05kB to jovial_meninsky:/usr/local/apache2/htdocs/index.html</li>
</ul></li>
</ul>
</section>
<section id="ch.-3-building-your-own-docker-images-with-dockerfile" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="ch.-3-building-your-own-docker-images-with-dockerfile">Ch. 3: Building your own docker images with Dockerfile</h3>
<ul>
<li><p><code>docker container run</code> will download image locally if it’s not on the machine because software distribution is built into the Docker platform. Or can use <code>docker image pull</code>.</p></li>
<li><p>Docker images may be packaged with default set of config values, but you should be able to provide different config settings when running a container (using environment variables for example, which are just key/value pairs provided by the operating system). For example, replace TARGET environment variable with google.com below:</p>
<ul>
<li>docker container run –env TARGET=google.com diamol/ch03-web-ping</li>
</ul></li>
<li><p>From a directory containing a <em>Dockerfile</em>, build an image with current directory as context via:</p>
<ul>
<li><code>docker image build --tag web-ping .</code></li>
</ul></li>
<li><p>Process for running apps with Docker:</p>
<ul>
<li>Write <em>Dockerfile</em> with steps to package the app</li>
<li>Collect the resources that need to go into Docker image</li>
<li>Decide how you want users of image to configure app behavior</li>
</ul></li>
<li><p>Image layers can be shared between different images and different containers. <img src="Docker_files/figure-html/cell-32-1-image.png" class="img-fluid" alt="image.png"></p></li>
<li><p>Notice how each gcr and mintonano image are listed at 17.4GB yet <code>docker system df</code> lists total usage at less than 18GB: This is because the layers between these two large images are shared!</p></li>
</ul>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-33-2-image.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<ul>
<li>Because image layers can be shared, they can’t be edited (read-only).</li>
<li>If contents/commands of a given step change, the following steps will be re-executed; previous layers are used from cache. Docker knows that previous layers didn’t change because their hash hasn’t changed (hash is made from instructions and files being copied).</li>
<li>Optimize the file by moving parts unlikely to change towards the top and combining commands:</li>
</ul>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-33-1-image-2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image-2.png</figcaption>
</figure>
</div>
<ul>
<li><p>Lab 3: Modifying contents of Docker container without modifying Dockerfile. <img src="Docker_files/figure-html/cell-34-1-image.png" class="img-fluid" alt="image.png"></p></li>
<li><p>Note that I ran <code>docker commit</code> while the diamol/ch03-lab was running, before typing exit. Then can go to the newly created container that now has new contents.</p></li>
</ul>
</section>
<section id="ch.-4-packaging-applications-from-source-code-into-docker-images" class="level3">
<h3 class="anchored" data-anchor-id="ch.-4-packaging-applications-from-source-code-into-docker-images">Ch. 4: Packaging applications from source code into Docker images</h3>
<p>In the provided Dockerfile, the build tools and dependencies are excluded from the final image by using a multi-stage build. Here’s how it works step-by-step:</p>
</section>
<section id="multi-stage-build-explanation" class="level3">
<h3 class="anchored" data-anchor-id="multi-stage-build-explanation">Multi-Stage Build Explanation</h3>
<ol type="1">
<li><p><strong>Builder Stage</strong>: ```Dockerfile FROM diamol/maven AS builder</p>
<p>WORKDIR /usr/src/iotd COPY pom.xml . RUN mvn -B dependency:go-offline</p>
<p>COPY . . RUN mvn package ```</p>
<ul>
<li><strong>Base Image</strong>: <code>diamol/maven</code> is used as the base image, which includes Maven and all necessary build tools.</li>
<li><strong>Working Directory</strong>: Sets the working directory to <code>/usr/src/iotd</code>.</li>
<li><strong>Copy <code>pom.xml</code></strong>: Copies the <code>pom.xml</code> file to the container.</li>
<li><strong>Download Dependencies</strong>: Runs <code>mvn -B dependency:go-offline</code> to download all dependencies specified in the <code>pom.xml</code> file.</li>
<li><strong>Copy Source Code</strong>: Copies the entire source code to the container.</li>
<li><strong>Build the Project</strong>: Runs <code>mvn package</code> to compile the source code and package it into a JAR file.</li>
</ul></li>
<li><p><strong>Application Stage</strong>: ```Dockerfile FROM diamol/openjdk</p>
<p>WORKDIR /app COPY –from=builder /usr/src/iotd/target/iotd-service-0.1.0.jar .</p>
<p>EXPOSE 80 ENTRYPOINT [“java”, “-jar”, “/app/iotd-service-0.1.0.jar”] ```</p>
<ul>
<li><strong>Base Image</strong>: <code>diamol/openjdk</code> is used as the base image, which includes only the JDK runtime environment.</li>
<li><strong>Working Directory</strong>: Sets the working directory to <code>/app</code>.</li>
<li><strong>Copy JAR File</strong>: Copies the JAR file from the <code>builder</code> stage to the <code>/app</code> directory in the application stage using <code>COPY --from=builder</code>.</li>
<li><strong>Expose Port</strong>: Informs Docker that the container will listen on port 80.</li>
<li><strong>Set Entry Point</strong>: Sets the command to run the JAR file using <code>java -jar</code>.</li>
</ul></li>
</ol>
</section>
<section id="how-build-tools-and-dependencies-are-excluded" class="level3">
<h3 class="anchored" data-anchor-id="how-build-tools-and-dependencies-are-excluded">How Build Tools and Dependencies are Excluded</h3>
<ul>
<li><strong>Builder Stage</strong>: The <code>builder</code> stage uses the <code>diamol/maven</code> image, which includes Maven and all necessary build tools to compile the Java application. This stage performs all the build-related tasks, such as downloading dependencies and packaging the application into a JAR file.</li>
<li><strong>Application Stage</strong>: The <code>app</code> stage uses the <code>diamol/openjdk</code> image, which only includes the JDK runtime environment. It does not include Maven or any other build tools.
<ul>
<li>The <code>COPY --from=builder</code> command copies only the compiled JAR file from the <code>builder</code> stage to the <code>app</code> stage. This means that none of the build tools, source code, or dependencies downloaded during the build process are included in the final image.</li>
<li>As a result, the final image is smaller and only contains the runtime environment and the packaged application, making it more efficient and secure.</li>
</ul></li>
</ul>
<p>By using multi-stage builds, you ensure that the final Docker image contains only what is necessary to run the application, excluding all build tools and intermediate files used during the build process.</p>
<ul>
<li><code>docker network create nat</code>: creates a Docker network, allowing any containers on the network to reach each other using the container names via a <em>bridge network</em>. Else containers can communicate via host’s networking space.</li>
<li>To run, use <code>docker run --name iotd -p 800:80 --network nat image-of-the-day</code>. Will run NASA’s image of the day REST API so you can make repeated calls to this application without hitting NASA’s service.</li>
</ul>
<section id="example-in-interpreted-application" class="level4">
<h4 class="anchored" data-anchor-id="example-in-interpreted-application">Example in interpreted application</h4>
<ul>
<li>Let’s break down the purpose of the final <code>WORKDIR</code> and <code>COPY</code> commands in the context of the provided Dockerfile:</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> diamol/node <span class="kw">AS</span> builder</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /src</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> src/package.json .</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">npm</span> install</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># app</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> diamol/node</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 80</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"node"</span>, <span class="st">"server.js"</span>]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=builder</span> /src/node_modules/ /app/node_modules/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="application-stage" class="level3">
<h3 class="anchored" data-anchor-id="application-stage">Application Stage</h3>
<section id="from-diamolnode" class="level4">
<h4 class="anchored" data-anchor-id="from-diamolnode">FROM diamol/node</h4>
<div class="sourceCode" id="cb7"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> diamol/node</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Purpose</strong>: Uses the <code>diamol/node</code> image as the base image for the application stage.</li>
<li><strong>Effect</strong>: This stage will be used to run the application.</li>
</ul>
</section>
<section id="expose-80" class="level4">
<h4 class="anchored" data-anchor-id="expose-80">EXPOSE 80</h4>
<div class="sourceCode" id="cb8"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 80</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Purpose</strong>: Informs Docker that the container will listen on port 80 at runtime.</li>
<li><strong>Effect</strong>: This is a documentation feature and does not actually publish the port.</li>
</ul>
</section>
<section id="cmd-node-server.js" class="level4">
<h4 class="anchored" data-anchor-id="cmd-node-server.js">CMD [“node”, “server.js”]</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"node"</span>, <span class="st">"server.js"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Purpose</strong>: Sets the default command to run when the container starts.</li>
<li><strong>Effect</strong>: The container will run <code>node server.js</code> when it starts.</li>
</ul>
</section>
<section id="workdir-app" class="level4">
<h4 class="anchored" data-anchor-id="workdir-app">WORKDIR /app</h4>
<div class="sourceCode" id="cb10"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Purpose</strong>: Sets the working directory to <code>/app</code> for subsequent instructions in the application stage.</li>
<li><strong>Effect</strong>: Any relative paths in subsequent commands will be relative to <code>/app</code>.</li>
</ul>
</section>
<section id="copy-frombuilder-srcnode_modules-appnode_modules" class="level4">
<h4 class="anchored" data-anchor-id="copy-frombuilder-srcnode_modules-appnode_modules">COPY –from=builder /src/node_modules/ /app/node_modules/</h4>
<div class="sourceCode" id="cb11"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> <span class="op">--from=builder</span> /src/node_modules/ /app/node_modules/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Purpose</strong>: Copies the <code>node_modules</code> directory from the <code>builder</code> stage to the <code>/app</code> directory in the application stage.</li>
<li><strong>Effect</strong>: This ensures that the application has access to the installed dependencies without including the entire build context.</li>
</ul>
</section>
</section>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<ul>
<li><strong>WORKDIR /app</strong>: Sets the working directory to <code>/app</code> for subsequent instructions. This helps in organizing the application files within the container.</li>
<li><strong>COPY –from=builder /src/node_modules/ /app/node_modules/</strong>: Copies the <code>node_modules</code> directory from the <code>builder</code> stage to the <code>/app</code> directory in the final image. This ensures that the final image contains the necessary runtime dependencies without including the entire build context.</li>
</ul>
<p>By using these commands, the Dockerfile ensures that the final image is clean and contains only the necessary files to run the application, while keeping the build process and dependencies separate.</p>
<ul>
<li>Example of ‘refactoring’ Dockerfile from ~500MB -&gt; ~17MB on Linux.</li>
</ul>
<div id="cell-41" class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>FROM diamol<span class="op">/</span>golang </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>WORKDIR web</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>COPY index.html .</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>COPY main.go .</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>RUN go build <span class="op">-</span>o <span class="op">/</span>web<span class="op">/</span>server</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>RUN chmod <span class="op">+</span>x <span class="op">/</span>web<span class="op">/</span>server</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>CMD [<span class="st">"/web/server"</span>]</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>ENV USER<span class="op">=</span>sixeyed</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>EXPOSE <span class="dv">80</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>The image built with this file includes the go compiler and other unnecessary build tools. In addition, any time we change index.html or anything prior to the RUN commands, the entire application will be rebuilt since RUN commands are in layers following these changes. The final-stage second image will not contain the build tools and if we change index.html, only the final layer will be rebuilt since others will come from cache.</li>
</ul>
<div id="cell-43" class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>FROM diamol<span class="op">/</span>golang AS builder</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>COPY main.go .</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>RUN go build <span class="op">-</span>o <span class="op">/</span>server</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>RUN chmod <span class="op">+</span>x <span class="op">/</span>server</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># app</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>FROM diamol<span class="op">/</span>base</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>EXPOSE <span class="dv">80</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>CMD [<span class="st">"/web/server"</span>]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>ENV USER<span class="op">=</span><span class="st">"sixeyed"</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>WORKDIR web</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>COPY <span class="op">--</span><span class="im">from</span><span class="op">=</span>builder <span class="op">/</span>server .</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>COPY index.html .</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ch.-5-sharing-images-with-docker-hub-and-other-registries" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="ch.-5-sharing-images-with-docker-hub-and-other-registries">Ch. 5: Sharing images with Docker Hub and other registries</h3>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-45-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>
<ul>
<li>Pushing images to Docker Hub:
<ul>
<li>Set dockerId environment variable: <code>export dockerId="my-docker-id"</code> (used to log in to Docker Hub)</li>
<li><code>docker login --username $dockerId</code></li>
<li><code>docker image tag image-gallery $dockerId/image-gallery:v1</code> (note that tagging an image built locally will not rebuild the image, will just make another reference to the same image)</li>
<li><code>docker image push $dockerId/image-gallery:v1</code></li>
</ul></li>
<li>Note that free version of Docker Hub only supports public repositories.</li>
</ul>
</section>
<section id="other-notes" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="other-notes">Other Notes</h3>
<ul>
<li>Restarting docker service installed with snap:</li>
</ul>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Docker_files/figure-html/cell-54-1-image.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">image.png</figcaption>
</figure>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/dpopovvelasco\.dev");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><span class="faux-block">© 2024 Dmitriy Popov-Velasco CC BY-SA 4.0</span></p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>